{% extends "admin_base.html" %}

{% block title %}Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† - Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª{% endblock %}

{% block page_heading %}Ù„ÛŒØ³Øª Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†{% endblock %}

{% block head_extra %}
<style>
    /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ Ø¬Ø¯ÙˆÙ„ */
    .user-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        text-align: right;
    }

    .user-table th, .user-table td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        text-align: right;
    }

    .user-table th {
        background-color: #3b3b5b;
        color: var(--primary-color);
        font-weight: bold;
    }

    .user-table tr:hover {
        background-color: #2e2e4a;
    }

    .user-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .score-input {
        width: 60px;
        padding: 5px;
        text-align: center !important;
    }
</style>
{% endblock %}

{% block content %}

<div id="status-message" class="alert" style="display: none;"></div>

<div class="card">
    <table class="user-table">
        <thead>
            <tr>
                <th>Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§ÛŒÙ…ÛŒÙ„/ØªÙ„ÙÙ†)</th>
                <th>Ø§Ù…ØªÛŒØ§Ø²</th>
                <th>ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ù…ÛŒÙˆÙ…</th>
                <th>ÙˆØ¶Ø¹ÛŒØª Ø¨Ù†</th>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr id="row-{{ user.identifier }}">
                <td data-identifier="{{ user.identifier }}" title="Ø§ÛŒÙ…ÛŒÙ„: {{ user.email }}, ØªÙ„ÙÙ†: {{ user.phone }}">
                    {{ user.identifier }}
                </td>
                <td>
                    <span id="score-{{ user.identifier }}">{{ user.score }}</span>
                    <input type="number" id="input-score-{{ user.identifier }}" class="score-input" value="{{ user.score }}" min="0">
                    <button class="btn btn-primary" onclick="adminAction('{{ user.identifier }}', 'set_score', document.getElementById('input-score-{{ user.identifier }}').value)">
                        â• Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø²
                    </button>
                </td>
                <td>
                    <span id="premium-{{ user.identifier }}" style="color: {% if user.is_premium %}#ffeb3b{% else %}#ccc{% endif %};">
                        {% if user.is_premium %}ğŸ’ Ù¾Ø±Ù…ÛŒÙˆÙ…{% else %}Ø¹Ø§Ø¯ÛŒ{% endif %}
                    </span>
                    <button class="btn {% if user.is_premium %}btn-danger{% else %}btn-primary{% endif %}" 
                            onclick="adminAction('{{ user.identifier }}', 'toggle_premium')">
                        {% if user.is_premium %}Ø¹Ø§Ø¯ÛŒ Ú©Ø±Ø¯Ù†{% else %}Ù¾Ø±Ù…ÛŒÙˆÙ… Ú©Ø±Ø¯Ù†{% endif %}
                    </button>
                </td>
                <td>
                    <span id="banned-{{ user.identifier }}" style="color: {% if user.is_banned %}var(--secondary-color){% else %}#28a745{% endif %}; font-weight: bold;">
                        {% if user.is_banned %}ğŸš« Ø¨Ù† Ø´Ø¯Ù‡{% else %}ÙØ¹Ø§Ù„{% endif %}
                    </span>
                    <button class="btn {% if user.is_banned %}btn-primary{% else %}btn-danger{% endif %}" 
                            onclick="adminAction('{{ user.identifier }}', 'toggle_ban')">
                        {% if user.is_banned %}Ø±ÙØ¹ Ø¨Ù†{% else %}Ø¨Ù† Ú©Ø±Ø¯Ù†{% endif %}
                    </button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align: center; color: #aaa;">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function showMessage(type, message) {
        const msgElement = document.getElementById('status-message');
        msgElement.className = 'alert ' + (type === 'success' ? 'alert-success' : 'alert-error');
        msgElement.textContent = message;
        msgElement.style.display = 'block';
        setTimeout(() => {
            msgElement.style.display = 'none';
        }, 5000); // Ù¾ÛŒØ§Ù… Ø¨Ø¹Ø¯ Ø§Ø² 5 Ø«Ø§Ù†ÛŒÙ‡ Ù…Ø®ÙÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    }

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ø¯Ù…ÛŒÙ†
    async function adminAction(identifier, action, value = null) {
        const url = '{{ url_for("admin.user_action") }}';

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ identifier, action, value })
            });

            const data = await response.json();

            if (response.ok && data.status === 'success') {
                showMessage('success', data.message);
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ (UI)
                updateUI(identifier, data.new_status);
            } else {
                showMessage('error', data.message || "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª.");
            }

        } catch (error) {
            console.error('Error:', error);
            showMessage('error', "Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.");
        }
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¹Ù†Ø§ØµØ± Ø¬Ø¯ÙˆÙ„ Ù¾Ø³ Ø§Ø² Ù‡Ø± Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚
    function updateUI(identifier, newStatus) {
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ù…ØªÛŒØ§Ø²
        document.getElementById(`score-${identifier}`).textContent = newStatus.score;
        document.getElementById(`input-score-${identifier}`).value = newStatus.score;

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ù…ÛŒÙˆÙ…
        const premiumSpan = document.getElementById(`premium-${identifier}`);
        const premiumButton = premiumSpan.nextElementSibling;
        
        if (newStatus.is_premium) {
            premiumSpan.textContent = 'ğŸ’ Ù¾Ø±Ù…ÛŒÙˆÙ…';
            premiumSpan.style.color = '#ffeb3b';
            premiumButton.textContent = 'Ø¹Ø§Ø¯ÛŒ Ú©Ø±Ø¯Ù†';
            premiumButton.className = 'btn btn-danger';
        } else {
            premiumSpan.textContent = 'Ø¹Ø§Ø¯ÛŒ';
            premiumSpan.style.color = '#ccc';
            premiumButton.textContent = 'Ù¾Ø±Ù…ÛŒÙˆÙ… Ú©Ø±Ø¯Ù†';
            premiumButton.className = 'btn btn-primary';
        }
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨Ù†
        const banSpan = document.getElementById(`banned-${identifier}`);
        const banButton = banSpan.nextElementSibling;
        
        if (newStatus.is_banned) {
            banSpan.textContent = 'ğŸš« Ø¨Ù† Ø´Ø¯Ù‡';
            banSpan.style.color = 'var(--secondary-color)';
            banButton.textContent = 'Ø±ÙØ¹ Ø¨Ù†';
            banButton.className = 'btn btn-primary';
        } else {
            banSpan.textContent = 'ÙØ¹Ø§Ù„';
            banSpan.style.color = '#28a745';
            banButton.textContent = 'Ø¨Ù† Ú©Ø±Ø¯Ù†';
            banButton.className = 'btn btn-danger';
        }
    }
</script>
{% endblock %}