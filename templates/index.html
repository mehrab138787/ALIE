<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyrus AI Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* ======================================================= */
        /* ğŸ¨ Variables (Glass, Electric Blue, Final)             */
        /* ======================================================= */
        :root {
            --app-height: 100vh;
            --bg-dark: #070707; 
            --card-dark: rgba(28, 28, 28, 0.85); 
            --neum-light: rgba(255, 255, 255, 0.05); 
            --neum-dark: rgba(0, 0, 0, 0.9);
            --accent-color: #222222; 
            --highlight-color: #03A9F4; /* Electric Blue */
            --user-bubble: #0084FF; /* iOS Blue */
            --ai-bubble-bg: #121212;
            --text-color: #FAFAFA;
            --muted-text: #999999;
            --code-bg: #000000;
            --code-text: #80DEEA; 
            --avatar-size: 40px; 
            --border-radius: 12px; 
            --loading-color: #81C784; 
            --premium-gold: #FFC107; /* ğŸŸ¡ Ø±Ù†Ú¯ Ø·Ù„Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ù…ÛŒÙˆÙ… */
        }

        /* ======================================================= */
        /* ğŸŒ Global & Layout                                       */
        /* ======================================================= */
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Vazirmatn', sans-serif;
            background: var(--bg-dark);
            color: var(--text-color);
            width: 100vw; height: var(--app-height); overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        #chat-app {
            width: 100%; height: var(--app-height); max-width: 100%;
            display: flex; flex-direction: column;
            background: var(--card-dark);
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            border-radius: 0; padding: 10px; 
            position: relative;
            overflow: hidden;
        }

        /* ======================================================= */
        /* ğŸ’ PREMIUM MODAL STYLES (ØªØ¨Ù„ÛŒØº ÙˆÛŒÚ˜Ù‡)                    */
        /* ======================================================= */
        #premium-promo-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.96); /* ØªÛŒØ±Ù‡â€ŒØªØ± Ø¨Ø±Ø§ÛŒ ØªÙ…Ø±Ú©Ø² Ø¨ÛŒØ´ØªØ± */
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            z-index: 3000; /* Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ù‡Ù…Ù‡ Ú†ÛŒØ² */
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }

        #premium-promo-modal.show { display: flex; opacity: 1; }

        .premium-card {
            background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
            border: 2px solid var(--premium-gold);
            box-shadow: 0 0 30px rgba(255, 193, 7, 0.3);
            width: 90%; max-width: 380px;
            padding: 30px 20px;
            border-radius: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #premium-promo-modal.show .premium-card { transform: scale(1); }

        /* Ø§ÙÚ©Øª Ù†ÙˆØ± Ø·Ù„Ø§ÛŒÛŒ Ù¾Ø³ Ø²Ù…ÛŒÙ†Ù‡ */
        .premium-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255, 193, 7, 0.15) 0%, transparent 70%);
            animation: rotate-glow 10s linear infinite; z-index: 0; pointer-events: none;
        }

        .premium-icon-box {
            width: 80px; height: 80px; margin: 0 auto 15px auto;
            background: rgba(255, 193, 7, 0.1); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            border: 1px solid var(--premium-gold);
            animation: pulse-gold 2s infinite;
        }
        
        .premium-icon-box i { font-size: 40px; color: var(--premium-gold); filter: drop-shadow(0 0 10px var(--premium-gold)); }

        .premium-title { font-size: 1.4rem; font-weight: 900; color: #FFF; margin-bottom: 10px; position: relative; z-index: 2; }
        .premium-title span { color: var(--premium-gold); }

        .premium-desc { font-size: 0.95rem; color: #ccc; line-height: 1.6; margin-bottom: 25px; position: relative; z-index: 2; }

        .btn-buy-premium {
            background: linear-gradient(45deg, #FFC107, #FF9800);
            color: #000; font-weight: 800; font-size: 1.1rem;
            width: 100%; padding: 12px; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 10px; position: relative; z-index: 2;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-buy-premium:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 193, 7, 0.6); }
        .btn-buy-premium:active { transform: scale(0.95); }

        .btn-later-premium {
            background: transparent; color: #777; border: none;
            font-size: 0.9rem; font-weight: 500; cursor: pointer;
            padding: 8px 15px; border-radius: 20px; transition: color 0.2s;
            position: relative; z-index: 2;
        }
        .btn-later-premium:hover { color: #FFF; background: rgba(255,255,255,0.05); }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }

        /* ======================================================= */
        /* ğŸ“£ MODAL STYLES (Ù†Ù…Ø§ÛŒØ´ ÙÙˆØ±ÛŒ Ùˆ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø´ÛŒÚ© - Ù‚Ø¯ÛŒÙ…ÛŒ)          */
        /* ======================================================= */
        #promo-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 2000; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.2s ease; 
        }
        #promo-modal.show { display: flex; opacity: 1; }
        @keyframes rotate-glow { to { transform: rotate(360deg); } }
        
        #modal-content {
            background: var(--card-dark); padding: 20px; border-radius: 15px;
            max-width: 90%; width: 400px; direction: rtl; text-align: right;
            transform: scale(0.9); transition: transform 0.3s ease;
            position: relative; z-index: 1; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.9); 
        }
        #promo-modal.show #modal-content { transform: scale(1); }

        #image-display-area {
            margin-bottom: 15px; border-radius: 10px; overflow: hidden;
            background: var(--bg-dark); text-align: center; position: relative; padding: 2px; 
        }
        #image-display-area::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: conic-gradient(transparent 0%, transparent 150deg, rgba(129, 199, 132, 0.9) 180deg, transparent 210deg);
            z-index: 0; animation: rotate-glow 5s linear infinite; filter: blur(10px); opacity: 0.8;
        }
        #image-display-area::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 10px; border: 2px solid rgba(129, 199, 132, 0.5); z-index: 2; pointer-events: none;
        }
        #promo-uploaded-image {
            position: relative; z-index: 1; width: 100%; height: auto;
            display: block; border-radius: 8px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
        }

        .promo-content { padding: 0 0 10px 0; margin-bottom: 15px; border-bottom: 1px solid var(--accent-color); }
        .promo-content p { color: #FFF; font-size: 1rem; line-height: 1.8; font-weight: 400; }
        .promo-content b { color: #FFEB3B; font-weight: 700; }
        .promo-action .promo-star-text { font-size: 0.9rem; color: var(--muted-text); margin-bottom: 20px; font-weight: 400; }

        .modal-footer {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            align-items: center; border-top: 1px solid var(--accent-color); padding-top: 10px;
        }
        .promo-btn {
            grid-column: 1 / -1; background: linear-gradient(45deg, #4CAF50, #00C853); 
            color: #FFF; padding: 10px 25px; border-radius: 25px;
            font-size: 1.1rem; font-weight: 700; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 200, 83, 0.4); transition: all 0.2s ease;
            width: 100%; margin-top: 5px; border: none;
        }
        .promo-btn:hover { box-shadow: 0 0 15px #00C853; transform: translateY(-2px); }
        .promo-btn i { margin-left: 10px; }
        
        #close-modal-btn {
            order: 2; background: var(--accent-color); color: var(--muted-text);
            border: none; padding: 10px 15px; border-radius: 25px;
            font-size: 0.95rem; font-weight: 500; cursor: pointer;
            transition: background 0.2s; width: 100%;
        }
        #close-modal-btn:hover { background: #444; color: #FFF; }

        #dont-show-again-label {
            order: 1; display: flex; align-items: center; justify-content: flex-start;
            font-size: 0.85rem; color: var(--muted-text); cursor: pointer;
            padding: 5px; border-radius: 15px; transition: background 0.2s;
        }
        #dont-show-again-label:hover { background: rgba(3, 169, 244, 0.05); color: #FFF; }
        #dont-show-again { margin-left: 8px; margin-right: 0; transform: scale(1.1); accent-color: var(--highlight-color); }
        
        /* ğŸ‘¤ Header (Minimal & Clean)                             */
        /* ======================================================= */
        #chat-header {
            padding: 15px 15px; background: var(--card-dark); color: var(--text-color);
            text-align: center; font-size: 1.6rem; font-weight: 900;
            border-bottom: 1px solid var(--accent-color); box-shadow: 0 1px 10px rgba(0, 0, 0, 0.5);
            position: relative; z-index: 10; margin-bottom: 10px; 
            text-shadow: 0 0 5px var(--highlight-color); 
        }
        #header-controls { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); display: flex; gap: 8px; }
        #chat-header button {
            background: var(--bg-dark); border: none; border-radius: 50%;
            width: 38px; height: 38px; color: var(--muted-text);
            font-size: 1rem; box-shadow: 5px 5px 12px var(--neum-dark), -5px -5px 12px var(--neum-light);
            transition: all 0.2s ease;
        }
        #chat-header button:hover { color: var(--highlight-color); box-shadow: 0 0 10px var(--highlight-color); }
        #chat-header button:active { transform: scale(0.9); box-shadow: inset 4px 4px 8px var(--neum-dark), inset -4px -4px 8px var(--neum-light); color: var(--highlight-color); }
        
        #menu-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }

        #premium-header-btn {
            position: absolute; right: 60px; top: 50%; transform: translateY(-50%); 
            background: var(--bg-dark); border: none; border-radius: 50%;
            width: 38px; height: 38px; color: #FFC107; font-size: 1.2rem; 
            box-shadow: 5px 5px 12px var(--neum-dark), -5px -5px 12px var(--neum-light);
            transition: all 0.2s ease; text-shadow: 0 0 5px rgba(255, 193, 7, 0.7);
        }
        #premium-header-btn:hover { color: #FFF; box-shadow: 0 0 10px #FFC107; }
        #premium-header-btn:active { transform: scale(0.9); box-shadow: inset 4px 4px 8px var(--neum-dark), inset -4px -4px 8px var(--neum-light); color: #FFF; }

        /* ğŸ’¬ Messages Area & Containers                           */
        /* ======================================================= */
        #messages {
            flex: 1; padding: 10px 5px; overflow-y: auto; 
            display: flex; flex-direction: column; scrollbar-width: none;
            background: rgba(0, 0, 0, 0.4); border: 1px solid var(--accent-color);
            border-radius: 15px; box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.9);
            margin-bottom: 10px; position: relative; 
        }
        #messages::-webkit-scrollbar { width: 0; height: 0; }
        
        #initial-prompt {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 1.2rem; font-weight: 700; color: var(--muted-text); opacity: 0.6;
            text-align: center; padding: 20px; pointer-events: none; transition: opacity 0.3s ease;
        }

        .message-container { display: flex; margin: 8px 0; justify-content: flex-start; align-items: flex-end; position: relative; }
        .user-container { justify-content: flex-end; }

        .avatar {
            width: var(--avatar-size); min-width: var(--avatar-size); height: var(--avatar-size);
            border-radius: 50%; background: var(--card-dark); 
            display: flex; justify-content: center; align-items: center; 
            font-size: 1.3rem; margin: 0 8px; border: 2px solid var(--accent-color);
            box-shadow: 5px 5px 10px var(--neum-dark), -5px -5px 10px var(--neum-light);
            transition: transform 0.3s ease;
        }
        .user-avatar { color: #00FFFF; } 
        .ai-avatar { color: var(--highlight-color); } 

        .message {
            padding: 12px 18px; border-radius: 20px; max-width: 80%; opacity: 0;
            transform: scale(0.95); animation: bubbleIn 0.3s forwards ease-out;
            position: relative; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.6); 
            line-height: 1.4; font-size: 0.95rem; direction: rtl; text-align: right;
            padding-bottom: 28px; 
        }
        
        .message .copyable-id { cursor: pointer; color: var(--highlight-color); font-weight: 700; text-decoration: none; direction: ltr !important; display: inline-block; }
        .message .copyable-id:hover { color: #FFF; }

        .id-copy-btn {
            background: none; border: none; color: var(--muted-text);
            font-size: 1em; cursor: pointer; padding: 2px 5px;
            border-radius: 4px; transition: all 0.2s; line-height: 1;
            margin-right: -5px; margin-left: 5px; display: inline-block;
        }
        .id-copy-btn:hover { color: var(--highlight-color); background: rgba(3, 169, 244, 0.1); }

        .message p { margin: 0; padding: 0; margin-bottom: 6px; }
        .message p:last-child { margin-bottom: 0; }

        @keyframes bubbleIn { 
            0% { opacity: 0; transform: scale(0.8) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .user { background: var(--user-bubble); color: #FFF; border-radius: 20px 8px 20px 20px; font-weight: 500; box-shadow: 0 3px 8px rgba(0, 132, 255, 0.4); }
        .ai { background: var(--ai-bubble-bg); color: var(--text-color); border-radius: 8px 20px 20px 20px; box-shadow: 5px 5px 10px var(--neum-dark), -5px -5px 10px var(--neum-light); }
        
        .highlight { box-shadow: 0 0 10px 2px var(--highlight-color), 0 0 5px var(--highlight-color); border: 1px solid var(--highlight-color); transition: box-shadow 0.6s ease-out, border 0.6s ease-out; }

        .copy-btn {
            position: absolute; bottom: 6px; width: 20px; height: 20px; 
            background: transparent; border: none; cursor: pointer;
            font-size: 0.85em; transition: color 0.2s, opacity 0.2s; opacity: 0.5;
        }
        .user .copy-btn { left: 10px; color: #FFF; } 
        .ai .copy-btn { right: 10px; color: var(--muted-text); } 
        .copy-btn:hover { opacity: 1; color: var(--highlight-color); }
        .user .copy-btn:hover { color: #FFF; }
        .copy-success { color: #00FF00 !important; } 

        code {
            direction: ltr; display: block; padding: 10px; background: var(--code-bg);
            border-radius: 8px; margin-top: 10px; overflow-x: auto;
            border-left: 4px solid #FFC107; font-size: 0.8em; color: var(--code-text); font-family: monospace;
            position: relative; padding-top: 30px; white-space: pre-wrap; word-break: break-all;
        }
        .code-copy-btn {
            position: absolute; top: 3px; left: 5px; right: unset; 
            background: rgba(255, 255, 255, 0.1); color: var(--muted-text);
            border: none; border-radius: 4px; cursor: pointer;
            font-size: 0.7em; padding: 3px 8px; opacity: 0.7;
            transition: opacity 0.2s, background 0.2s, color 0.2s; direction: rtl; z-index: 5;
        }
        .code-copy-btn:hover { opacity: 1; background: rgba(3, 169, 244, 0.2); color: var(--highlight-color); }
        .code-copy-btn .fas { margin-left: 5px; }
        
        .loading {
            font-style: italic; opacity: 0.9; background: var(--ai-bubble-bg);
            padding-right: 5px; animation: pulse 1s infinite alternate;
        }
        .loading::after { content: '_'; animation: blink 1s infinite step-start; }
        @keyframes pulse { 0% { opacity: 0.8; transform: scale(0.99); } 100% { opacity: 1; transform: scale(1.01); } }
        @keyframes blink { 50% { opacity: 0; } }
        
        .ai-image-container { display: flex; flex-direction: column; align-items: flex-end; width: 100%; }
        .ai-image {
            max-width: 95%; max-height: 300px; margin: 8px 0 8px 0; 
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6), 0 0 15px 3px var(--highlight-color);
        }

        /* âŒ¨ï¸ Input Area (Glassy)                                  */
        /* ======================================================= */
        #input-container {
            display: flex; background: var(--card-dark); padding: 10px; align-items: center;
            border: 1px solid var(--accent-color); border-radius: 20px; 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7); z-index: 20;
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
        }

        #image-btn {
            width: 45px; height: 45px; border-radius: 50%; margin-left: 5px; 
            background: var(--bg-dark); color: var(--highlight-color);
            font-size: 1.2rem; box-shadow: 5px 5px 10px var(--neum-dark), -5px -5px 10px var(--neum-light); 
            pointer-events: auto; opacity: 1; display: flex; justify-content: center; align-items: center;
            transition: all 0.2s ease; cursor: pointer;
        }
        #image-btn:hover { color: #FFF; box-shadow: 0 0 10px var(--highlight-color); }
        #image-btn:active { transform: scale(0.9); box-shadow: inset 4px 4px 8px var(--neum-dark), inset -4px -4px 8px var(--neum-light); color: #FFF; }

        #user-input {
            flex: 1; padding: 12px 20px; border: none; border-radius: 25px; outline: none;
            font-size: 1rem; background: var(--bg-dark); color: var(--text-color);
            margin: 0 8px; box-shadow: inset 5px 5px 10px var(--neum-dark), inset -5px -5px 10px var(--neum-light);
            direction: rtl; resize: none; overflow-y: hidden; max-height: 100px; line-height: 1.4; 
        }
        #user-input::placeholder { color: var(--muted-text); }
        #user-input:focus { box-shadow: inset 0 0 15px rgba(3, 169, 244, 0.6); border: 1px solid var(--highlight-color); }

        .input-btn {
            width: 45px; height: 45px; border: none; border-radius: 50%; cursor: pointer;
            font-size: 1.2rem; color: #FFF; 
            background: linear-gradient(45deg, var(--highlight-color), #0077C0);
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.7), 0 0 8px rgba(3, 169, 244, 0.5); 
            transition: transform 0.1s ease, box-shadow 0.2s ease;
        }
        #send-btn:active { 
            background: #0077C0; transform: scale(0.9); 
            box-shadow: inset 4px 4px 8px var(--neum-dark), inset -4px -4px 8px var(--neum-light), 0 0 15px rgba(3, 169, 244, 0.8); 
        }

        /* ğŸ’¡ DRAWER (SIDEBAR) STYLES                              */
        /* ======================================================= */
        #drawer {
            position: fixed; top: 0; right: 0; width: 80%; max-width: 300px; height: var(--app-height);
            background: var(--bg-dark); border-left: 3px solid var(--highlight-color);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.8); z-index: 1000;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            padding-top: 50px; display: flex; flex-direction: column; overflow-y: auto; 
        }
        #drawer.open { transform: translateX(0); }

        #drawer-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #drawer.open + #drawer-backdrop { opacity: 1; pointer-events: auto; }

        .drawer-link {
            display: flex; align-items: center; padding: 18px 20px; margin: 8px 10px; 
            color: var(--text-color); text-decoration: none; font-size: 1.1rem; font-weight: 500;
            border-radius: var(--border-radius); transition: all 0.2s ease; direction: rtl;
            background: var(--card-dark); box-shadow: 4px 4px 8px var(--neum-dark), -4px -4px 8px var(--neum-light);
            border-right: 5px solid transparent;
        }
        .drawer-link:hover {
            background: var(--accent-color); border-right: 5px solid var(--highlight-color);
            color: var(--highlight-color); transform: translateX(-5px);
        }
        .drawer-link i {
            margin-left: 15px; font-size: 1.4rem; min-width: 30px; text-align: center;
            color: var(--highlight-color); text-shadow: 0 0 5px rgba(3, 169, 244, 0.7);
        }
        
        .drawer-link.disabled-link {
            cursor: not-allowed; opacity: 0.5; pointer-events: none; 
            color: var(--muted-text) !important; padding-top: 18px; padding-bottom: 18px;
            background: var(--card-dark); box-shadow: none; border-right: 5px solid transparent;
        }
        .drawer-link.disabled-link small {
            font-size: 0.85em; font-weight: 500; margin-right: 5px; color: #81C784; 
        }
    </style>
</head>
<body>
    
<audio id="send-sound" src="https://assets.mixkit.co/sfx/download/mixkit-bell-notification-978.wav" preload="auto"></audio>
<audio id="bubble-sound" src="https://assets.mixkit.co/sfx/download/mixkit-bubble-pop-sound-2810.wav" preload="auto"></audio>

<div id="premium-promo-modal">
    <div class="premium-card">
        <div class="premium-icon-box">
            <i class="fas fa-crown"></i>
        </div>
        <h2 class="premium-title">ğŸš€ Ù‚Ø¯Ø±Øª ÙˆØ§Ù‚Ø¹ÛŒ <span>Ø³Ø§ÛŒØ±ÙˆØ³</span> Ø±Ø§ Ø¢Ø²Ø§Ø¯ Ú©Ù†ÛŒØ¯!</h2>
        <p class="premium-desc">
            Ù‡Ù†ÙˆØ² Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ù‡ Ù†Ø³Ø®Ù‡ Ø¹Ø§Ø¯ÛŒ Ù‡Ø³ØªÛŒØ¯ØŸ <br>
            Ø¨Ø§ <b>Ù¾Ø±Ù…ÛŒÙˆÙ…</b>ØŒ Ø³Ø±Ø¹Øª Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒ Û² Ø¨Ø±Ø§Ø¨Ø±ØŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ùˆ Ú†Øª Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±Ø§ ØªØ¬Ø±Ø¨Ù‡ Ú©Ù†ÛŒØ¯.
        </p>
        
        <button class="btn-buy-premium" onclick="window.location.href='{{ url_for('premium_page') }}'">
            <i class="fas fa-rocket"></i> ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§Ø´ØªØ±Ø§Ú© ÙˆÛŒÚ˜Ù‡
        </button>
        
        <button class="btn-later-premium" id="premium-later-btn">
            Ø´Ø§ÛŒØ¯ Ø¨Ø¹Ø¯Ø§Ù‹
        </button>
    </div>
</div>
<div id="promo-modal">
    <div id="modal-content">
        
        <div id="image-display-area">
            <img id="promo-uploaded-image" src="{{ url_for('static', filename='images/1.png') }}" alt="ØªØµÙˆÛŒØ± Ø¨Ù†Ø±" style="display: block;">
        </div>
        
        <div class="promo-content">
            <p style="font-size: 1rem; font-weight: 500; line-height: 1.8;">
                <b>â¤ï¸ Ù‡Ù…Ø±Ø§Ù‡ Ú¯Ø±Ø§Ù…ÛŒØŒ Ø³Ù¾Ø§Ø³ Ø§Ø² Ø­Ø¶ÙˆØ± Ø´Ù…Ø§.</b>
                Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ú©Ø§Ø± Ø±ÙˆÛŒ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù‡ÛŒØ¬Ø§Ù†â€ŒØ§Ù†Ú¯ÛŒØ² Ù‡Ø³ØªÛŒÙ….
            </p>
            <p style="font-size: 1rem; font-weight: 500; line-height: 1.8; margin-top: 10px;">
                Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ù…Ú©Ø§Ù†Ø§ØªÛŒ Ù…Ø§Ù†Ù†Ø¯
                <span style="color: #81C784; font-weight: 700; text-shadow: 0 0 8px #4CAF50;">ØªÙˆÙ„ÛŒØ¯ Ù…ÙˆØ³ÛŒÙ‚ÛŒ</span> Ùˆ
                <span style="color: #81C784; font-weight: 700; text-shadow: 0 0 8px #4CAF50;">ØªÙˆÙ„ÛŒØ¯ ÙˆÛŒØ¯ÛŒÙˆ</span> Ø¯Ø± Ø§Ø®ØªÛŒØ§Ø± Ø´Ù…Ø§ Ù‚Ø±Ø§Ø± Ø®ÙˆØ§Ù‡Ø¯ Ú¯Ø±ÙØª.
            </p>
        </div>
        <div class="promo-action">
            <p class="promo-star-text" style="font-size: 0.9rem; margin-bottom: 20px;">
                Ø­Ù…Ø§ÛŒØª Ùˆ Ù‡Ù…Ø¯Ù„ÛŒ Ø´Ù…Ø§ Ø¨Ø§
                <span style="color: #81C784; font-weight: 900; font-size: 1.05rem; text-shadow: 0 0 8px #4CAF50;">Ø§Ù…ØªÛŒØ§Ø² Ûµ Ø³ØªØ§Ø±Ù‡</span> Ø¯Ø± Ú©Ø§ÙÙ‡ Ø¨Ø§Ø²Ø§Ø±ØŒ Ø³Ø±Ø¹Øª ØªÙˆØ³Ø¹Ù‡ Ø§ÛŒÙ† Ø§Ù…Ú©Ø§Ù†Ø§Øª Ø±Ø§ Ú†Ù†Ø¯ Ø¨Ø±Ø§Ø¨Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
            </p>
        </div>
        
        <div class="modal-footer">
            
            <button id="rate-us-btn" class="promo-btn" 
                    onclick="window.open('https://cafebazaar.ir/app/io.kodular.mehrabzyzy300.Cyrus', '_blank');">
                <i class="fas fa-comments"></i> Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø² Ûµ Ø³ØªØ§Ø±Ù‡ Ùˆ Ø­Ù…Ø§ÛŒØª
            </button>
            
            <label id="dont-show-again-label">
                <input type="checkbox" id="dont-show-again">
                Ø¯ÛŒÚ¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù†Ø¯Ù‡
            </label>
            
            <button id="close-modal-btn" class="modal-btn">Ø±Ø¯ Ú©Ø±Ø¯Ù†</button>
        </div>
        </div>
</div>
<div id="drawer">
    <div style="padding: 20px; font-size: 1.8rem; font-weight: 700; color: var(--highlight-color); text-align: center; border-bottom: 1px solid var(--accent-color); margin-bottom: 20px;">
        Ù…Ù†Ùˆ
    </div>
    
    <a href="{{ url_for('premium_page') }}" class="drawer-link" style="color: #FFC107; font-weight: 700;">
        <i class="fas fa-crown" style="color: #FFC107; text-shadow: 0 0 5px rgba(255, 193, 7, 0.7);"></i> 
        Ø®Ø±ÛŒØ¯ Ù¾Ø±Ù…ÛŒÙˆÙ… Ø§Ø² Ú©Ø§ÙÙ‡ Ø¨Ø§Ø²Ø§Ø±
    </a>
    
    <a href="{{ url_for('image_page') }}" class="drawer-link" style="color: var(--highlight-color); font-weight: 500;">
        <i class="fas fa-palette"></i> ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±
    </a>
    
    <span class="drawer-link disabled-link" title="Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯">
        <i class="fas fa-music"></i> ØªÙˆÙ„ÛŒØ¯ Ù…ÙˆØ³ÛŒÙ‚ÛŒ (<small>Ø¨Ø²ÙˆØ¯ÛŒ</small>)
    </span>
    
    <hr style="margin: 10px 0; border-color: rgba(255, 255, 255, 0.1);">
    
    {% if logged_in %}
        <a href="{{ url_for('my_conversations') }}" class="drawer-link">
            <i class="fas fa-history"></i> Ø¢Ø±Ø´ÛŒÙˆ Ú¯ÙØªÚ¯Ùˆ
        </a>
        <a href="{{ url_for('account') }}" class="drawer-link">
            <i class="fas fa-user-circle"></i> Ø­Ø³Ø§Ø¨ Ù…Ù†
        </a>
    {% else %}
        <a href="{{ url_for('login') }}" class="drawer-link">
            <i class="fas fa-sign-in-alt"></i> **ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øª Ù†Ø§Ù…**
        </a>
    {% endif %}

    <a href="{{ url_for('support') }}" class="drawer-link">
        <i class="fas fa-hands-helping"></i> Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ
    </a>
    <a href="{{ url_for('about') }}" class="drawer-link">
        <i class="fas fa-info-circle"></i> Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§
    </a>

    {% if logged_in %}
        <a href="{{ url_for('logout') }}" class="drawer-link" style="color: #FF6666; margin-top: auto; border-top: 1px solid var(--accent-color);">
            <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
        </a>
    {% endif %}
</div>
<div id="drawer-backdrop"></div>

<div id="chat-app">
    <div id="chat-header">
        <button id="premium-header-btn" title="Ø®Ø±ÛŒØ¯ Ù¾Ø±Ù…ÛŒÙˆÙ…" onclick="window.location.href='{{ url_for('premium_page') }}';">
            <i class="fas fa-crown"></i>
        </button>
        
        <button id="menu-btn" title="Ù…Ù†Ùˆ"><i class="fas fa-bars"></i></button> Cyrus
        
        <div id="header-controls">
            <button id="clear-btn" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú†Øª"><i class="fas fa-trash-alt"></i></button>
        </div>
    </div>
    
    <div id="messages">
        <div id="initial-prompt">
            Ú†Ø·ÙˆØ± Ù…ÛŒØªÙˆÙ†Ù… Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ù…ØŸ ğŸ¤”
        </div>
    </div>
    
    <div id="input-container">
        <button id="image-btn" class="input-btn" title="ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±" onclick="window.location.href='{{ url_for('image_page') }}';">
            <i class="fas fa-image"></i>
        </button>

        <textarea id="user-input" rows="1" placeholder=" Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
        
        <button id="send-btn" class="input-btn" title="Ø§Ø±Ø³Ø§Ù„"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script>
// Ø¹Ù†Ø§ØµØ± DOM Ø§ØµÙ„ÛŒ
const input = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");
const clearBtn = document.getElementById("clear-btn");
const messages = document.getElementById("messages");
const sendSound = document.getElementById("send-sound");
const bubbleSound = document.getElementById("bubble-sound");
const initialPrompt = document.getElementById("initial-prompt"); 

// Ø¹Ù†Ø§ØµØ± Ø³Ø§ÛŒØ¯Ø¨Ø§Ø±
const menuBtn = document.getElementById("menu-btn");
const drawer = document.getElementById("drawer");
const backdrop = document.getElementById("drawer-backdrop");

// ğŸ†• Ø¹Ù†Ø§ØµØ± Modal Ù‚Ø¯ÛŒÙ…ÛŒ
const promoModal = document.getElementById("promo-modal");
const closeModalBtn = document.getElementById("close-modal-btn");
const dontShowAgainCheckbox = document.getElementById("dont-show-again");

// ğŸ’ğŸ’ğŸ’ Ø¹Ù†Ø§ØµØ± Modal Ù¾Ø±Ù…ÛŒÙˆÙ… Ø¬Ø¯ÛŒØ¯ ğŸ’ğŸ’ğŸ’
const premiumModal = document.getElementById("premium-promo-modal");
const premiumLaterBtn = document.getElementById("premium-later-btn");

/* ======================================================= */
/* ğŸ› ï¸ Utility & Setup                                     */
/* ======================================================= */

function setAppHeight() {
    document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
}
window.addEventListener('resize', setAppHeight);
window.addEventListener('orientationchange', setAppHeight);
setAppHeight();

let chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]");

if (chatHistory.length > 0) {
    chatHistory.forEach(m => appendMessage(m.text, m.className, false, m.image_url)); 
    initialPrompt.style.display = 'none'; 
    enableCopyableId();
} else {
    initialPrompt.style.display = 'block'; 
}

function escapeHtml(str) {
    if (!str) return "";
    return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function playSendSound() {
    sendSound.currentTime = 0;
    sendSound.play().catch(e => console.log("Send sound play error:", e));
}

function playBubbleSound() {
    bubbleSound.currentTime = 0;
    bubbleSound.play().catch(e => console.log("Bubble sound play error:", e));
}

function fallbackCopy(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    
    textarea.style.position = 'fixed';
    textarea.style.top = '0';
    textarea.style.left = '0';
    textarea.style.opacity = '0';
    
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (!successful) {
             console.error('Fallback copy failed!');
             alert("Ú©Ù¾ÛŒ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.");
        }
    } catch (err) {
        console.error('Fallback copy failed!', err);
        alert("Ú©Ù¾ÛŒ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.");
    }

    document.body.removeChild(textarea);
}

function feedback(button) {
    const originalIconClass = button.querySelector('i').className;
    button.querySelector('i').className = 'fas fa-check';
    button.classList.add('copy-success');

    setTimeout(() => {
        button.querySelector('i').className = originalIconClass;
        button.classList.remove('copy-success');
    }, 1000);
}

function copyMessage(button, textToCopy) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textToCopy).then(() => {
            feedback(button);
        }).catch(() => {
            fallbackCopy(textToCopy);
            feedback(button);
        });
        return; 
    } else {
        fallbackCopy(textToCopy);
        feedback(button);
    }
}

function enableCopyableId() {
    const copyButtons = document.querySelectorAll('.id-copy-btn');
    
    copyButtons.forEach(button => {
        if (!button.hasAttribute('data-copied-listener')) {
            button.addEventListener('click', () => {
                const textToCopy = button.getAttribute('data-id');
                const originalInnerHTML = button.innerHTML; 
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        button.innerHTML = '<i class="fas fa-check"></i> Ú©Ù¾ÛŒ Ø´Ø¯!';
                        button.style.color = '#00FF00'; 
                        
                        setTimeout(() => {
                            button.innerHTML = originalInnerHTML;
                            button.style.color = ''; 
                        }, 1500);
                        
                    }).catch(err => {
                        console.error('Could not copy text using API: ', err);
                        fallbackCopy(textToCopy);
                        
                        button.innerHTML = '<i class="fas fa-check"></i> Ú©Ù¾ÛŒ Ø´Ø¯!';
                        button.style.color = '#00FF00'; 
                        
                        setTimeout(() => {
                            button.innerHTML = originalInnerHTML;
                            button.style.color = ''; 
                        }, 1500);
                    });
                } else {
                    fallbackCopy(textToCopy);
                    
                    button.innerHTML = '<i class="fas fa-check"></i> Ú©Ù¾ÛŒ Ø´Ø¯!';
                    button.style.color = '#00FF00'; 
                    
                    setTimeout(() => {
                        button.innerHTML = originalInnerHTML;
                        button.style.color = ''; 
                    }, 1500);
                }
            });
            button.setAttribute('data-copied-listener', 'true'); 
        }
    });
}


/* ======================================================= */
/* ğŸ§­ DRAWER / SWIPE LOGIC                                 */
/* ======================================================= */

function openDrawer() {
    drawer.classList.add('open');
}

function closeDrawer() {
    drawer.classList.remove('open');
}

menuBtn.addEventListener('click', openDrawer);
backdrop.addEventListener('click', closeDrawer);

let touchStartX = 0;

document.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1 && e.touches[0].clientX > window.innerWidth * 0.7) {
        touchStartX = e.touches[0].clientX;
    } else {
        touchStartX = 0;
    }
}, { passive: true }); 

document.addEventListener('touchend', (e) => {
    if (touchStartX === 0) return;
    
    const touchEndX = e.changedTouches[0].clientX;
    const distance = touchStartX - touchEndX; 

    if (distance > 80) { 
        openDrawer();
    } 
    else if (drawer.classList.contains('open') && distance < -80) {
        closeDrawer();
    }

    touchStartX = 0; 
}, { passive: true });


/* ======================================================= */
/* ğŸ’¬ Messaging Logic                                      */
/* ======================================================= */

function appendMessage(text, className, highlight = true, imageUrl = null) {
    if (initialPrompt.style.display !== 'none') {
        initialPrompt.style.display = 'none';
    }

    const container = document.createElement("div");
    container.classList.add("message-container", `${className}-container`);

    const msg = document.createElement("div");
    msg.classList.add("message", className);
    
    // 1. Ø³Ø§Ø®Øª Ø¢ÙˆØ§ØªØ§Ø±
    const avatar = document.createElement("div");
    avatar.classList.add("avatar", `${className}-avatar`);
    avatar.innerHTML = className === 'user' ? '<i class="fas fa-hat-cowboy"></i>' : '<i class="fas fa-brain"></i>';
    
    // 2. Ø³Ø§Ø®Øª Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ Ú©Ù„ Ù¾ÛŒØ§Ù…
    const copyButton = document.createElement("button");
    copyButton.classList.add("copy-btn");
    copyButton.innerHTML = '<i class="fas fa-copy"></i>';
    copyButton.addEventListener('click', () => copyMessage(copyButton, text));
    
    // 3. Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÛŒØ§Ù… (Ú©Ø¯ Ùˆ Ù…ØªÙ†)
    let processedText = text;
    let hasCodeBlock = processedText.includes("```");

    if (className === 'ai' && !hasCodeBlock) {
        const customIdRegex = /<span class='copyable-id'>(.*?)<\/span>/g;
        processedText = processedText.replace(customIdRegex, (match, id) => {
            const finalId = id.trim();
            const idCopyButtonHtml = 
                `<button class="id-copy-btn" data-id="@${finalId}" title="Ú©Ù¾ÛŒ Ø¢ÛŒØ¯ÛŒ">
                    <i class="fas fa-copy"></i>
                </button>`;
            return `<span class="copyable-id" data-id="@${finalId}">${finalId}</span>${idCopyButtonHtml}`;
        });
    }


    if (hasCodeBlock) {
        const parts = text.split(/```/);
        msg.innerHTML = "";
        for (let i = 0; i < parts.length; i++) {
            if (i % 2 === 0) {
                let formattedPart = parts[i].trim();
                
                if (className === 'ai') {
                    const telegramIdRegex = /@([a-zA-Z0-9_]+)/g;
                    formattedPart = formattedPart.replace(telegramIdRegex, (match, id) => {
                         return `<span class="copyable-id" data-id="@${id}">@${id}</span>`;
                    });
                    
                    const customIdRegex = /<span class='copyable-id'>(.*?)<\/span>/g;
                    formattedPart = formattedPart.replace(customIdRegex, (match, id) => {
                         const finalId = id.trim();
                         return `<span class="copyable-id" data-id="@${finalId}">${finalId}</span>`;
                    });

                }
                
                const formatted = formattedPart.split('\n').map(p => {
                    const idAndButtonRegex = /<span class="copyable-id".+?<\/span>\s*(<button class="id-copy-btn".+?<\/button>)?/g;
                    let tempP = p;
                    const idMatches = [];

                    tempP = tempP.replace(idAndButtonRegex, (match) => {
                        idMatches.push(match);
                        return "__ID_PLACEHOLDER__";
                    });

                    tempP = escapeHtml(tempP); 
                    
                    tempP = tempP.replace(new RegExp("__ID_PLACEHOLDER__", 'g'), () => idMatches.shift());
                    
                    tempP = tempP.replace(/\*\*(.+?)\*\*/g, "<b>$1</b>");
                    tempP = tempP.replace(/__(.+?)__/g, "<i>$1</i>");
                    return tempP ? `<p>${tempP}</p>` : '';
                }).join('');
                
                msg.insertAdjacentHTML('beforeend', formatted);

            } else {
                const codeText = parts[i].replace(/^\s*\w+\n?/, "").trim(); 
                const codeBlock = document.createElement("code");
                codeBlock.textContent = codeText;
                
                const codeCopyBtn = document.createElement("button");
                codeCopyBtn.classList.add("code-copy-btn");
                codeCopyBtn.innerHTML = '<i class="fas fa-copy"></i>Ú©Ù¾ÛŒ Ú©Ø¯';
                codeCopyBtn.addEventListener('click', () => copyMessage(codeCopyBtn, codeText));
                
                codeBlock.prepend(codeCopyBtn); 
                msg.appendChild(codeBlock);
            }
        }
    } else {
        const formatted = processedText.trim().split('\n').map(p => {
            
            let tempP = p;
            
            const idAndButtonRegex = /<span class="copyable-id".+?<\/span>\s*<button class="id-copy-btn".+?<\/button>/g;
            const idMatches = [];
            
            tempP = tempP.replace(idAndButtonRegex, (match) => {
                idMatches.push(match);
                return "__ID_PLACEHOLDER__";
            });
            
            tempP = escapeHtml(tempP); 
            
            tempP = tempP.replace(new RegExp("__ID_PLACEHOLDER__", 'g'), () => idMatches.shift());
            
            
            tempP = tempP.replace(/\*\*(.+?)\*\*/g, "<b>$1</b>");
            tempP = tempP.replace(/__(.+?)__/g, "<i>$1</i>");
            return tempP ? `<p>${tempP}</p>` : '';
        }).join('');
        msg.insertAdjacentHTML('beforeend', formatted);
    }
    
    if (className === 'ai' && imageUrl) {
        const imageWrapper = document.createElement('div');
        imageWrapper.classList.add('ai-image-container');
        
        const imageElement = document.createElement('img');
        imageElement.src = imageUrl;
        imageElement.alt = "ØªØµÙˆÛŒØ± ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· AI";
        imageElement.classList.add('ai-image');
        
        imageWrapper.appendChild(imageElement);
        msg.appendChild(imageWrapper);
        
        imageElement.onload = () => {
             messages.scrollTop = messages.scrollHeight;
        };
    }
    
    msg.appendChild(copyButton);

    if (className === 'user') {
        container.appendChild(msg);
        container.appendChild(avatar);
    } else {
        container.appendChild(avatar);
        container.appendChild(msg);
    }

    messages.appendChild(container);

    if (className === 'ai' && !className.includes('loading')) {
        enableCopyableId(); 
    }
    
    if (className !== 'loading') { 
        messages.scrollTop = messages.scrollHeight;

        chatHistory.push({ text, className, image_url: imageUrl }); 
        localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    }
    
    if (highlight) {
        msg.classList.add("highlight");
        setTimeout(() => msg.classList.remove("highlight"), 800);
    }

    while (messages.children.length > 50) {
        messages.removeChild(messages.children[0]);
        chatHistory.shift();
        localStorage.removeItem("chatHistory");
    }
}


// Ø­Ø¨Ø§Ø¨ Ù„ÙˆØ¯ÛŒÙ†Ú¯
function showLoadingBubble() {
    if (initialPrompt.style.display !== 'none') {
        initialPrompt.style.display = 'none';
    }

    const container = document.createElement("div");
    container.classList.add("message-container", "ai-container");

    const avatar = document.createElement("div");
    avatar.classList.add("avatar", "ai-avatar");
    avatar.innerHTML = '<i class="fas fa-brain"></i>';
    container.appendChild(avatar);

    const bubble = document.createElement("div");
    bubble.classList.add("message", "ai", "loading");
    bubble.textContent = "... Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†";
    container.appendChild(bubble);

    messages.appendChild(container);
    messages.scrollTop = messages.scrollHeight;
    
    return { container, bubble };
}

// -------------------------------------------------------------------
// ğŸ¯ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¨Ú©â€ŒØ§Ù†Ø¯ Flask
// -------------------------------------------------------------------
async function sendMessage() {
    const message = input.value.trim();
    if (!message) return;
    
    sendBtn.disabled = true;
    input.disabled = true;
    
    appendMessage(message, "user");
    playSendSound(); 

    input.value = "";
    input.style.height = 'auto'; 

    const { container: loadingContainer, bubble: loadingElem } = showLoadingBubble();

    try {
        const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: message })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        const responseText = data.reply || "Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù¾Ø§Ø³Ø®ÛŒ Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.";
        const imageUrl = data.image_url || null;

        loadingElem.textContent = "";
        loadingElem.classList.remove("loading"); 

        let i = 0;
        const interval = setInterval(() => {
            if (i < responseText.length) {
                loadingElem.textContent += responseText.charAt(i); 
                i++;
                messages.scrollTop = messages.scrollHeight; 
            } else {
                clearInterval(interval);
                messages.removeChild(loadingContainer);
                appendMessage(loadingElem.textContent, "ai", true, imageUrl);
                playBubbleSound();
                
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
                
                autoGrowTextarea();
            }
        }, 0); 

    } catch (error) {
        console.error("Fetch error:", error);
        messages.removeChild(loadingContainer);
        appendMessage(`<b>Ø®Ø·Ø§:</b> ${error.message} (Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.)`, "ai");
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
        
        autoGrowTextarea();
    }
}


/* ======================================================= */
/* ğŸ“ˆ Textarea Auto-Grow Logic                            */
/* ======================================================= */

function autoGrowTextarea() {
    input.style.height = 'auto'; 
    let newHeight = input.scrollHeight;
    input.style.height = newHeight + 'px';
    messages.scrollTop = messages.scrollHeight; 
    input.scrollIntoView({ behavior: 'smooth', block: 'end' });
}


/* ======================================================= */
/* ğŸ“¢ MODAL LOGIC (Ù¾Ø§Ù¾â€ŒØ¢Ù¾â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ùˆ Ø¬Ø¯ÛŒØ¯)                */
/* ======================================================= */

// 1. Ù…Ù†Ø·Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ù‚Ø¯ÛŒÙ…ÛŒ (Cafebazaar Promo)
function showPromoModal() {
    if (localStorage.getItem('hidePromoModal') !== 'true') {
        promoModal.classList.add('show');
    }
}
function hidePromoModal() {
    promoModal.classList.remove('show');
    if (dontShowAgainCheckbox.checked) {
        localStorage.setItem('hidePromoModal', 'true');
    }
}
closeModalBtn.addEventListener('click', hidePromoModal);
promoModal.addEventListener('click', (e) => {
    if (e.target === promoModal) hidePromoModal();
});


// 2. ğŸ’ğŸ’ğŸ’ Ù…Ù†Ø·Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±Ù…ÛŒÙˆÙ… (PREMIUM LOGIC) ğŸ’ğŸ’ğŸ’
let premiumTimer = null;

function showPremiumModal() {
    // Ø§Ú¯Ø± Ù…ÙˆØ¯Ø§Ù„ Ù‚Ø¯ÛŒÙ…ÛŒ Ø¨Ø§Ø² Ø§Ø³ØªØŒ Ù¾Ø±Ù…ÛŒÙˆÙ… Ø±Ø§ Ù†Ø´Ø§Ù† Ù†Ø¯Ù‡ ØªØ§ ØªØ¯Ø§Ø®Ù„ Ù†Ú©Ù†Ø¯
    if(promoModal.classList.contains('show')) return;
    
    premiumModal.classList.add('show');
}

function hidePremiumModal() {
    premiumModal.classList.remove('show');
}

function scheduleNextPremiumPopup(isLater = false) {
    if (premiumTimer) clearTimeout(premiumTimer);
    
    let delay;
    if (isLater) {
        // Ø§Ú¯Ø± "Ø¨Ø¹Ø¯Ø§" Ø²Ø¯Ù‡ Ø´Ø¯: Ø¯Ù‚ÛŒÙ‚Ø§ 5 Ø¯Ù‚ÛŒÙ‚Ù‡ (300,000 Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡)
        delay = 300000;
        console.log("Premium Popup scheduled for 5 minutes later.");
    } else {
        // Ø²Ù…Ø§Ù† ØªØµØ§Ø¯ÙÛŒ Ø¨ÛŒÙ† 2 ØªØ§ 5 Ø¯Ù‚ÛŒÙ‚Ù‡ (120,000 ØªØ§ 300,000 Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡)
        const min = 120000; 
        const max = 300000;
        delay = Math.floor(Math.random() * (max - min + 1) + min);
        console.log(`Premium Popup scheduled in ${Math.round(delay/60000)} minutes.`);
    }

    premiumTimer = setTimeout(() => {
        showPremiumModal();
    }, delay);
}

// Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯Ú©Ù…Ù‡ "Ø´Ø§ÛŒØ¯ Ø¨Ø¹Ø¯Ø§Ù‹"
premiumLaterBtn.addEventListener('click', () => {
    hidePremiumModal();
    scheduleNextPremiumPopup(true); // 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
});

// Ø¨Ø³ØªÙ† Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
premiumModal.addEventListener('click', (e) => {
    if (e.target === premiumModal) {
        hidePremiumModal();
        scheduleNextPremiumPopup(true); // ÙØ±Ø¶ Ø¨Ø± Ø§ÛŒÙ† Ø§Ø³Øª Ú©Ù‡ Ø¨Ø³ØªÙ† ÛŒØ¹Ù†ÛŒ "Ø¨Ø¹Ø¯Ø§"
    }
});


// ğŸ’¡ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
window.addEventListener('load', () => {
    // Ø§ÙˆÙ„ Ù…ÙˆØ¯Ø§Ù„ Ù‚Ø¯ÛŒÙ…ÛŒ Ú†Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ù†Ù…Ø§ÛŒØ´ ÙÙˆØ±ÛŒ)
    showPromoModal();
    
    // Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±Ù…ÛŒÙˆÙ… (Ø¨ÛŒÙ† 2 ØªØ§ 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ø§Ø² Ø´Ø¯Ù†)
    scheduleNextPremiumPopup(false);
});


// -------------------------------------------------------------------
// ğŸš¦ Event Listeners (Ø§ØµÙ„ÛŒ)
// -------------------------------------------------------------------

sendBtn.addEventListener("click", sendMessage);

input.addEventListener("input", autoGrowTextarea); 

input.addEventListener("focus", () => {
    setTimeout(() => {
        document.getElementById("input-container").scrollIntoView({ 
            behavior: 'smooth', 
            block: 'end' 
        });
    }, 100); 
});

input.addEventListener("keypress", (event) => {
    if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault(); 
        sendMessage();
    }
});

clearBtn.addEventListener("click", () => {
    if (confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú©Ù„ Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ")) {
        messages.innerHTML = `<div id="initial-prompt">Ú†Ø·ÙˆØ± Ù…ÛŒØªÙˆÙ†Ù… Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ù…ØŸ ğŸ¤”</div>`;
        initialPrompt.style.display = 'block';
        localStorage.removeItem("chatHistory");
        chatHistory = []; 
        alert("Ú¯ÙØªÚ¯Ùˆ Ù¾Ø§Ú© Ø´Ø¯.");
        input.style.height = 'auto';
    }
});
</script>
</body>
</html>