<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyrus AI Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* ======================================================= */
        /* ğŸ¨ Variables (Glass, Electric Blue, Final)             */
        /* ======================================================= */
        :root {
            --app-height: 100vh;
            --bg-dark: #070707; 
            --card-dark: rgba(28, 28, 28, 0.85); 
            --neum-light: rgba(255, 255, 255, 0.05); 
            --neum-dark: rgba(0, 0, 0, 0.9);
            --accent-color: #222222; 
            --highlight-color: #03A9F4; 
            --user-bubble: #0084FF; 
            --ai-bubble-bg: #121212;
            --text-color: #FAFAFA;
            --muted-text: #999999;
            --code-bg: #000000;
            --code-text: #80DEEA; 
            --avatar-size: 45px; 
            --border-radius: 15px; 
        }

        /* ======================================================= */
        /* ğŸŒ Global & Layout                                     */
        /* ======================================================= */
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Vazirmatn', sans-serif;
            background: var(--bg-dark);
            color: var(--text-color);
            width: 100vw; height: var(--app-height); overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        #chat-app {
            width: 100%; height: var(--app-height); max-width: 100%;
            display: flex; flex-direction: column;
            background: var(--card-dark);
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            border-radius: 0; padding: 15px;
        }

        /* ======================================================= */
        /* ğŸ‘¤ Header (Minimal & Clean)                             */
        /* ======================================================= */
        #chat-header {
            padding: 20px 20px; background: var(--card-dark); color: var(--text-color);
            text-align: center; font-size: 2rem; font-weight: 900;
            border-bottom: 1px solid var(--accent-color); 
            box-shadow: 0 1px 10px rgba(0, 0, 0, 0.5);
            position: relative; z-index: 10; margin-bottom: 15px;
            text-shadow: 0 0 5px var(--highlight-color); 
        }

        #header-controls {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: flex; gap: 12px;
        }
        #chat-header button {
            background: var(--bg-dark); border: none; border-radius: 50%;
            width: 45px; height: 45px; color: var(--muted-text);
            font-size: 1.1rem;
            box-shadow: 5px 5px 12px var(--neum-dark), -5px -5px 12px var(--neum-light);
            transition: all 0.2s ease;
        }
        #chat-header button:hover { color: var(--highlight-color); box-shadow: 0 0 10px var(--highlight-color); }
        #chat-header button:active { transform: scale(0.9); box-shadow: inset 4px 4px 8px var(--neum-dark), inset -4px -4px 8px var(--neum-light); color: var(--highlight-color); }


        /* ======================================================= */
        /* ğŸ’¬ Messages Area & Containers                           */
        /* ======================================================= */
        #messages {
            flex: 1; padding: 15px 10px; overflow-y: auto; scroll-behavior: smooth;
            display: flex; flex-direction: column; scrollbar-width: none;
            background: rgba(0, 0, 0, 0.4); 
            border: 1px solid var(--accent-color);
            border-radius: var(--border-radius); 
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.9);
            margin-bottom: 15px;
            /* ğŸ’¡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù‚Ø±Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù¾Ø±Ø§Ù…Ù¾Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø± Ù…Ø±Ú©Ø² */
            position: relative; 
        }
        #messages::-webkit-scrollbar { width: 0; height: 0; }
        
        /* ğŸŒŸ Ø§Ø³ØªØ§ÛŒÙ„ Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø± Ù…Ø±Ú©Ø² ØµÙØ­Ù‡ ğŸŒŸ */
        #initial-prompt {
            position: absolute; 
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%); /* Ù‚Ø±Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¯Ø± Ù…Ø±Ú©Ø² */
            font-size: 1.4rem; 
            font-weight: 700;
            color: var(--muted-text); /* Ø±Ù†Ú¯ Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù…Ù„Ø§ÛŒÙ… */
            opacity: 0.6;
            text-align: center;
            padding: 20px;
            pointer-events: none; /* ØªØ§ Ù…Ø²Ø§Ø­Ù…ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ú©Ù†Ø¯ */
            transition: opacity 0.3s ease;
        }

        .message-container {
            display: flex; margin: 12px 0; 
            justify-content: flex-start; align-items: flex-end;
            position: relative;
        }
        .user-container { justify-content: flex-end; }

        /* Ø¢ÙˆØ§ØªØ§Ø± */
        .avatar {
            width: var(--avatar-size); min-width: var(--avatar-size); height: var(--avatar-size);
            border-radius: 50%; 
            background: var(--card-dark); 
            display: flex; justify-content: center; align-items: center; 
            font-size: 1.5rem; 
            margin: 0 12px; 
            border: 2px solid var(--accent-color);
            box-shadow: 5px 5px 10px var(--neum-dark), -5px -5px 10px var(--neum-light);
            transition: transform 0.3s ease;
        }
        .user-avatar { color: #00FFFF; } 
        .ai-avatar { color: var(--highlight-color); } 


        /* ------------------ Ø­Ø¨Ø§Ø¨ Ù¾ÛŒØ§Ù… (Ø¨Ø§ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¬Ù‡Ø´ÛŒ) ------------------ */
        .message {
            padding: 18px 25px; 
            border-radius: 30px; 
            max-width: 75%; 
            opacity: 0;
            transform: scale(0.95); 
            animation: bubbleIn 0.5s forwards cubic-bezier(0.68, -0.55, 0.27, 1.55);
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6); 
            line-height: 1.7;
            font-size: 1.05rem;
            direction: rtl; 
            text-align: right;
            padding-bottom: 35px; 
        }
        
        /* Ú©ÛŒâ€ŒÙØ±ÛŒÙ… Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ÙˆØ±ÙˆØ¯ */
        @keyframes bubbleIn {  
            0% { opacity: 0; transform: scale(0.8) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .user {
            background: var(--user-bubble); color: #FFF; 
            border-radius: 30px 10px 30px 30px;
            font-weight: 600;
        }
        .ai {
            background: var(--ai-bubble-bg); color: var(--text-color);
            border-radius: 10px 30px 30px 30px;
            box-shadow: 5px 5px 10px var(--neum-dark), -5px -5px 10px var(--neum-light);
        }
        
        /* Ø¬Ù„ÙˆÙ‡ Highlight Ù†Ø¦ÙˆÙ†ÛŒ */
        .highlight {
            box-shadow: 0 0 15px 3px var(--highlight-color), 0 0 5px var(--highlight-color);
            border: 2px solid var(--highlight-color);
            transition: box-shadow 0.6s ease-out, border 0.6s ease-out;
        }

        /* ------------------ Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ ------------------ */
        .copy-btn {
            position: absolute; bottom: 10px; width: 25px; height: 25px;
            background: transparent; border: none; cursor: pointer;
            font-size: 1em; transition: color 0.2s, opacity 0.2s; opacity: 0.5;
        }

        .user .copy-btn { left: 15px; color: #FFF; } 
        .ai .copy-btn { right: 15px; color: var(--muted-text); }
        .copy-btn:hover { opacity: 1; color: var(--highlight-color); }
        .user .copy-btn:hover { color: #FFF; }
        
        .copy-success { color: #00FF00 !important; } 

        /* ------------------ Ú©Ø¯ Ø¨Ù„Ø§Ú© Ùˆ Ù„ÙˆØ¯ÛŒÙ†Ú¯ ------------------ */
        code {
            direction: ltr; display: block; padding: 15px; background: var(--code-bg);
            border-radius: 10px; margin-top: 15px; overflow-x: auto;
            border-left: 5px solid var(--highlight-color); 
            font-size: 0.9em; color: var(--code-text); font-family: monospace;
        }
        
        /* Ø§ÙÚ©Øª Ú†Ø´Ù…Ú©â€ŒØ²Ù† Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ÛŒÙ†Ú¯ (ÙˆØ§Ù‚Ø¹ÛŒâ€ŒØªØ±) */
        .loading {
            font-style: italic; opacity: 0.9; background: var(--ai-bubble-bg);
            padding-right: 5px; 
            animation: pulse 1s infinite alternate;
        }
        .loading::after {
            content: '_'; 
            animation: blink 1s infinite step-start;
        }
        @keyframes pulse {  
            0% { opacity: 0.8; transform: scale(0.99); } 
            100% { opacity: 1; transform: scale(1.01); } 
        }
        @keyframes blink {
            50% { opacity: 0; }
        }

        /* ======================================================= */
        /* âŒ¨ï¸ Input Area (Glassy)                                  */
        /* ======================================================= */
        #input-container {
            display: flex; background: var(--card-dark); padding: 15px; align-items: center;
            border: 1px solid var(--accent-color); border-radius: var(--border-radius);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7); z-index: 20;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        #user-input {
            flex: 1; padding: 18px 25px; border: none; border-radius: 35px; outline: none;
            font-size: 1.1rem; 
            background: var(--bg-dark); color: var(--text-color);
            margin: 0 10px; 
            box-shadow: inset 5px 5px 10px var(--neum-dark), inset -5px -5px 10px var(--neum-light);
            direction: rtl;
        }
        #user-input::placeholder { color: var(--muted-text); }
        #user-input:focus { 
            box-shadow: inset 0 0 15px rgba(3, 169, 244, 0.6); 
            border: 1px solid var(--highlight-color); 
        }

        .input-btn {
            width: 60px; height: 60px; border: none; border-radius: 50%; cursor: pointer;
            font-size: 1.5rem; color: var(--bg-dark);
            background: var(--highlight-color);
            box-shadow: 5px 5px 10px var(--neum-dark), -5px -5px 10px var(--neum-light);
            transition: transform 0.1s ease;
        }
        #send-btn:active { 
            background: #0077C0; 
            transform: scale(0.9); 
            box-shadow: inset 4px 4px 8px var(--neum-dark), inset -4px -4px 8px var(--neum-light); 
        }

        /* ======================================================= */
        /* ğŸŒŸ MOBILE OPTIMIZATION (ØªÙ†Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ú¯ÙˆØ´ÛŒ) */
        /* ======================================================= */
        @media (max-width: 600px) {
            :root {
                --avatar-size: 40px; 
                --border-radius: 12px;
            }
            #chat-app { padding: 10px; }
            #chat-header { padding: 15px 15px; font-size: 1.6rem; margin-bottom: 10px; }
            #chat-header button { width: 38px; height: 38px; font-size: 1rem; }
            #messages { padding: 10px 5px; margin-bottom: 10px; }
            .message-container { margin: 8px 0; }
            .avatar { margin: 0 8px; font-size: 1.3rem; }
            .message {
                padding: 12px 18px; 
                border-radius: 20px; 
                max-width: 80%; 
                font-size: 0.9rem; 
                padding-bottom: 28px; 
            }
            .user { border-radius: 20px 8px 20px 20px; }
            .ai { border-radius: 8px 20px 20px 20px; }
            code { padding: 10px; font-size: 0.8em; }
            .copy-btn { bottom: 6px; width: 20px; height: 20px; font-size: 0.85em; }
            .user .copy-btn { left: 10px; } 
            .ai .copy-btn { right: 10px; }
            #input-container { padding: 10px; }
            #user-input { padding: 12px 20px; font-size: 1rem; }
            .input-btn { width: 45px; height: 45px; font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    
<audio id="send-sound" src="https://assets.mixkit.co/sfx/download/mixkit-bell-notification-978.wav" preload="auto"></audio>
<audio id="bubble-sound" src="https://assets.mixkit.co/sfx/download/mixkit-bubble-pop-sound-2810.wav" preload="auto"></audio>

<div id="chat-app">
    <div id="chat-header">
        Cyrus
        <div id="header-controls">
            <button id="clear-btn" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú†Øª"><i class="fas fa-trash-alt"></i></button>
        </div>
    </div>
    
    <div id="messages">
        <div id="initial-prompt">
            Ú†Ø·ÙˆØ± Ù…ÛŒØªÙˆÙ†Ù… Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ù…ØŸ ğŸ¤”
        </div>
    </div>
    
    <div id="input-container">
        <input type="text" id="user-input" placeholder=" Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ Ùˆ Enter Ø¨Ø²Ù†ÛŒØ¯...">
        <button id="send-btn" class="input-btn" title="Ø§Ø±Ø³Ø§Ù„"><i class="fas fa-rocket"></i></button>
    </div>
</div>

<script>
// Ø¹Ù†Ø§ØµØ± DOM
const input = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");
const clearBtn = document.getElementById("clear-btn");
const messages = document.getElementById("messages");
const sendSound = document.getElementById("send-sound");
const bubbleSound = document.getElementById("bubble-sound");

// ğŸ’¡ Ø¹Ù†ØµØ± Ø¬Ø¯ÛŒØ¯
const initialPrompt = document.getElementById("initial-prompt"); 


/* ======================================================= */
/* ğŸ› ï¸ Utility & Setup                                     */
/* ======================================================= */

function setAppHeight() {
    document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
}
window.addEventListener('resize', setAppHeight);
window.addEventListener('orientationchange', setAppHeight);
setAppHeight();

let chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]");

// ğŸ’¡ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
if (chatHistory.length > 0) {
    chatHistory.forEach(m => appendMessage(m.text, m.className, false));
    initialPrompt.style.display = 'none'; // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù‡Ø³Øª
} else {
    initialPrompt.style.display = 'block'; // Ù†Ù…Ø§ÛŒØ´ Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†ÛŒØ³Øª
}

function escapeHtml(str) {
    if (!str) return "";
    return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function playSendSound() {
    sendSound.currentTime = 0;
    sendSound.play().catch(e => console.log("Send sound play error:", e));
}

function playBubbleSound() {
    bubbleSound.currentTime = 0;
    bubbleSound.play().catch(e => console.log("Bubble sound play error:", e));
}

/** ğŸ› ï¸ ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ú©Ù¾ÛŒ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Textarea (Ø±ÙˆØ´ Ø³Ù†ØªÛŒ) */
function fallbackCopy(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    
    textarea.style.position = 'fixed';
    textarea.style.top = '0';
    textarea.style.left = '0';
    textarea.style.opacity = '0';
    
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (!successful) {
             console.error('Fallback copy failed!');
             alert("Ú©Ù¾ÛŒ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.");
        }
    } catch (err) {
        console.error('Fallback copy failed!', err);
        alert("Ú©Ù¾ÛŒ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.");
    }

    document.body.removeChild(textarea);
}

/** ğŸ”” Ù†Ù…Ø§ÛŒØ´ ÙÛŒØ¯Ø¨Ú© Ø¨ØµØ±ÛŒ Ù…ÙˆÙÙ‚ÛŒØª */
function feedback(button) {
    const originalIconClass = button.querySelector('i').className;
    button.querySelector('i').className = 'fas fa-check';
    button.classList.add('copy-success');

    setTimeout(() => {
        button.querySelector('i').className = originalIconClass;
        button.classList.remove('copy-success');
    }, 1000);
}

function copyMessage(button, textToCopy) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textToCopy).then(() => {
            feedback(button);
        }).catch(() => {
            fallbackCopy(textToCopy);
            feedback(button);
        });
        return; 
    } else {
        fallbackCopy(textToCopy);
        feedback(button);
    }
}


/* ======================================================= */
/* ğŸ’¬ Messaging Logic                                      */
/* ======================================================= */

function appendMessage(text, className, highlight = true) {
    // ğŸ’¡ Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù†Ú¯Ø§Ù… Ø¯Ø±ÛŒØ§ÙØª Ø§ÙˆÙ„ÛŒÙ† Ù¾ÛŒØ§Ù…
    if (initialPrompt.style.display !== 'none') {
        initialPrompt.style.display = 'none';
    }

    const container = document.createElement("div");
    container.classList.add("message-container", `${className}-container`);

    const msg = document.createElement("div");
    msg.classList.add("message", className);
    // ... (Ø¨Ù‚ÛŒÙ‡ Ú©Ø¯Ù‡Ø§ÛŒ Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù… Ù…Ø´Ø§Ø¨Ù‡ Ù‚Ø¨Ù„ Ø§Ø³Øª) ...
    
    // 1. Ø³Ø§Ø®Øª Ø¢ÙˆØ§ØªØ§Ø±
    const avatar = document.createElement("div");
    avatar.classList.add("avatar", `${className}-avatar`);
    avatar.innerHTML = className === 'user' ? '<i class="fas fa-hat-cowboy"></i>' : '<i class="fas fa-brain"></i>';
    
    // 2. Ø³Ø§Ø®Øª Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ
    const copyButton = document.createElement("button");
    copyButton.classList.add("copy-btn");
    copyButton.innerHTML = '<i class="fas fa-copy"></i>';
    copyButton.addEventListener('click', () => copyMessage(copyButton, text));
    
    // 3. Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÛŒØ§Ù… (Ú©Ø¯ Ùˆ Ù…ØªÙ†)
    if (text.includes("```")) {
        const parts = text.split(/```/);
        msg.innerHTML = "";
        for (let i = 0; i < parts.length; i++) {
            if (i % 2 === 0) {
                const formatted = parts[i].trim().split('\n').map(p => {
                    p = escapeHtml(p);
                    p = p.replace(/\*\*(.+?)\*\*/g, "<b>$1</b>");
                    p = p.replace(/__(.+?)__/g, "<i>$1</i>");
                    return p ? `<p>${p}</p>` : '';
                }).join('');
                msg.insertAdjacentHTML('beforeend', formatted);
            } else {
                const codeBlock = document.createElement("code");
                codeBlock.textContent = parts[i].replace(/^\s*\w+\n?/, "").trim(); 
                msg.appendChild(codeBlock);
            }
        }
    } else {
        const formatted = text.trim().split('\n').map(p => {
            p = escapeHtml(p);
            p = p.replace(/\*\*(.+?)\*\*/g, "<b>$1</b>");
            p = p.replace(/__(.+?)__/g, "<i>$1</i>");
            return p ? `<p>${p}</p>` : '';
        }).join('');
        msg.insertAdjacentHTML('beforeend', formatted);
    }
    
    msg.appendChild(copyButton);

    // 4. Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø¢ÙˆØ§ØªØ§Ø± Ùˆ Ù¾ÛŒØ§Ù… Ø¯Ø± Ú©Ø§Ù†ØªÛŒÙ†Ø±
    if (className === 'user') {
        container.appendChild(msg);
        container.appendChild(avatar);
    } else {
        container.appendChild(avatar);
        container.appendChild(msg);
    }

    messages.appendChild(container);

    if (className !== 'loading') { 
        messages.scrollTop = messages.scrollHeight;

        chatHistory.push({ text, className });
        localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    }
    

    if (highlight) {
        msg.classList.add("highlight");
        setTimeout(() => msg.classList.remove("highlight"), 800);
    }

    // Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§Ø±ÛŒØ®Ú†Ù‡
    while (messages.children.length > 50) {
        messages.removeChild(messages.children[0]);
        chatHistory.shift();
        localStorage.removeItem("chatHistory");
    }
}


// Ø­Ø¨Ø§Ø¨ Ù„ÙˆØ¯ÛŒÙ†Ú¯
function showLoadingBubble() {
    // ğŸ’¡ Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù†Ú¯Ø§Ù… Ù†Ù…Ø§ÛŒØ´ Ù„ÙˆØ¯ÛŒÙ†Ú¯
    if (initialPrompt.style.display !== 'none') {
        initialPrompt.style.display = 'none';
    }

    const container = document.createElement("div");
    container.classList.add("message-container", "ai-container");

    const avatar = document.createElement("div");
    avatar.classList.add("avatar", "ai-avatar");
    avatar.innerHTML = '<i class="fas fa-brain"></i>';
    container.appendChild(avatar);

    const bubble = document.createElement("div");
    bubble.classList.add("message", "ai", "loading");
    bubble.textContent = "... Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†";
    container.appendChild(bubble);

    messages.appendChild(container);
    messages.scrollTop = messages.scrollHeight;
    
    return { container, bubble };
}

// -------------------------------------------------------------------
// ğŸ¯ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¨Ú©â€ŒØ§Ù†Ø¯ Flask (Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø­ÙØ¸ Ø§Ø³Ú©Ø±ÙˆÙ„)
// -------------------------------------------------------------------

async function sendMessage() {
    const message = input.value.trim();
    if (!message) return;
    
    sendBtn.disabled = true;
    input.disabled = true;
    
    appendMessage(message, "user");
    playSendSound(); 

    input.value = "";

    const { container: loadingContainer, bubble: loadingElem } = showLoadingBubble();

    try {
        const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: message })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        const responseText = data.reply || "Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù¾Ø§Ø³Ø®ÛŒ Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.";

        loadingElem.textContent = "";
        let i = 0;
        const interval = setInterval(() => {
            if (i < responseText.length) {
                loadingElem.textContent += responseText[i];
                i++;
                
                const isUserAtBottom = messages.scrollHeight - messages.clientHeight <= messages.scrollTop + 50; 
                if (isUserAtBottom) {
                    messages.scrollTop = messages.scrollHeight; 
                }

            } else {
                clearInterval(interval);
                
                playBubbleSound(); 

                messages.removeChild(loadingContainer);
                appendMessage(responseText, "ai", true);
                
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }, 20); 

    } catch (e) {
        console.error("Error connecting to backend:", e);
        loadingElem.textContent = "âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± (app.py).";
        loadingElem.classList.remove("loading");
        loadingElem.style.animation = 'none'; 
        
        sendBtn.disabled = false;
        input.disabled = false;
    }
}

function clearChat() {
    if (confirm("Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øª Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) {
        fetch("/clear_history", { method: "POST" }); 
        messages.innerHTML = ''; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
        
        // ğŸ’¡ Ù†Ù…Ø§ÛŒØ´ Ù…Ø¬Ø¯Ø¯ Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„ÛŒÙ‡ Ù¾Ø³ Ø§Ø² Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
        messages.appendChild(initialPrompt);
        initialPrompt.style.display = 'block'; 

        chatHistory = [];
        localStorage.removeItem("chatHistory");
    }
}

// Event Listeners
sendBtn.addEventListener("click", sendMessage);
input.addEventListener("keypress", e => { 
    if (e.key === "Enter" && !sendBtn.disabled) sendMessage(); 
});
clearBtn.addEventListener("click", clearChat);
</script>
</body>
</html>