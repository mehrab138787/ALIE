<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyrus AI Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* ======================================================= */
        /* ğŸ¨ Variables (Glass, Electric Blue, Final)             */
        /* ======================================================= */
        :root {
            --app-height: 100vh;
            --bg-dark: #070707; 
            --card-dark: rgba(28, 28, 28, 0.85); 
            --neum-light: rgba(255, 255, 255, 0.05); 
            --neum-dark: rgba(0, 0, 0, 0.9);
            --accent-color: #222222; 
            --highlight-color: #03A9F4; 
            --user-bubble: #0084FF; 
            --ai-bubble-bg: #121212;
            --text-color: #FAFAFA;
            --muted-text: #999999;
            --code-bg: #000000;
            --code-text: #80DEEA; 
            --avatar-size: 45px; 
            --border-radius: 15px; 
            --loading-color: #FFC107; /* Ø±Ù†Ú¯ Ø¨Ø±Ø§ÛŒ "Ø¨Ø²ÙˆØ¯ÛŒ" */
        }

        /* ======================================================= */
        /* ğŸŒ Global & Layout                                       */
        /* ======================================================= */
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Vazirmatn', sans-serif;
            background: var(--bg-dark);
            color: var(--text-color);
            width: 100vw; height: var(--app-height); overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        #chat-app {
            width: 100%; height: var(--app-height); max-width: 100%;
            display: flex; flex-direction: column;
            background: var(--card-dark);
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            border-radius: 0; padding: 15px;
            position: relative;
            overflow: hidden;
        }

        /* ======================================================= */
        /* ğŸ’¡ DRAWER (SIDEBAR) STYLES */
        /* ======================================================= */
        #drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 80%; 
            max-width: 300px;
            height: var(--app-height);
            background: var(--bg-dark); 
            border-left: 3px solid var(--highlight-color);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.8);
            z-index: 1000;
            transform: translateX(100%); 
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            padding-top: 50px;
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
        }

        #drawer.open {
            transform: translateX(0); 
        }

        #drawer-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #drawer.open + #drawer-backdrop {
            opacity: 1;
            pointer-events: auto;
        }

        /* ------------------ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± ------------------ */
        .drawer-link {
            display: flex;
            align-items: center;
            padding: 20px;
            margin: 10px 15px;
            color: var(--text-color);
            text-decoration: none;
            font-size: 1.2rem;
            font-weight: 500;
            border-radius: var(--border-radius);
            transition: all 0.2s ease;
            direction: rtl;
            background: var(--card-dark);
            box-shadow: 4px 4px 8px var(--neum-dark), -4px -4px 8px var(--neum-light);
            border-right: 5px solid transparent;
        }

        .drawer-link:hover {
            background: var(--accent-color);
            border-right: 5px solid var(--highlight-color);
            color: var(--highlight-color);
            transform: translateX(-5px);
        }

        .drawer-link i {
            margin-left: 15px; 
            font-size: 1.5rem;
            min-width: 30px;
            text-align: center;
            color: var(--highlight-color);
            text-shadow: 0 0 5px rgba(3, 169, 244, 0.7);
        }
        
        /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù„ÛŒÙ†Ú© ØºÛŒØ±ÙØ¹Ø§Ù„ (Ø¨Ø²ÙˆØ¯ÛŒ) --- */
        .drawer-link.disabled-link {
            cursor: not-allowed; 
            opacity: 0.5; 
            pointer-events: none; 
            color: var(--muted-text) !important; 
            padding-top: 20px;
            padding-bottom: 20px;
            background: var(--card-dark); 
            box-shadow: none; 
            border-right: 5px solid transparent;
        }

        .drawer-link.disabled-link small {
            font-size: 0.9em;
            font-weight: 500;
            margin-right: 5px;
            color: var(--loading-color); 
        }
        /* ======================================================= */

        /* ğŸ‘¤ Header (Minimal & Clean)                             */
        /* ======================================================= */
        #chat-header {
            padding: 20px 20px; background: var(--card-dark); color: var(--text-color);
            text-align: center; font-size: 2rem; font-weight: 900;
            border-bottom: 1px solid var(--accent-color); 
            box-shadow: 0 1px 10px rgba(0, 0, 0, 0.5);
            position: relative; z-index: 10; margin-bottom: 15px;
            text-shadow: 0 0 5px var(--highlight-color); 
        }

        #header-controls {
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%); display: flex; gap: 12px;
        }
        #chat-header button {
            background: var(--bg-dark); border: none; border-radius: 50%;
            width: 45px; height: 45px; color: var(--muted-text);
            font-size: 1.1rem;
            box-shadow: 5px 5px 12px var(--neum-dark), -5px -5px 12px var(--neum-light);
            transition: all 0.2s ease;
        }
        #chat-header button:hover { color: var(--highlight-color); box-shadow: 0 0 10px var(--highlight-color); }
        #chat-header button:active { transform: scale(0.9); box-shadow: inset 4px 4px 8px var(--neum-dark), inset -4px -4px 8px var(--neum-light); color: var(--highlight-color); }
        
        #menu-btn {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
        }


        /* ======================================================= */
        /* ğŸ’¬ Messages Area & Containers                           */
        /* ======================================================= */
        #messages {
            flex: 1; padding: 15px 10px; overflow-y: auto; 
            display: flex; flex-direction: column; scrollbar-width: none;
            background: rgba(0, 0, 0, 0.4); 
            border: 1px solid var(--accent-color);
            border-radius: var(--border-radius); 
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.9);
            margin-bottom: 15px;
            position: relative; 
        }
        #messages::-webkit-scrollbar { width: 0; height: 0; }
        
        #initial-prompt {
            position: absolute; 
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%); 
            font-size: 1.4rem; 
            font-weight: 700;
            color: var(--muted-text); 
            opacity: 0.6;
            text-align: center;
            padding: 20px;
            pointer-events: none; 
            transition: opacity 0.3s ease;
        }

        .message-container {
            display: flex; margin: 12px 0; 
            justify-content: flex-start; align-items: flex-end;
            position: relative;
        }
        .user-container { justify-content: flex-end; }

        .avatar {
            width: var(--avatar-size); min-width: var(--avatar-size); height: var(--avatar-size);
            border-radius: 50%; 
            background: var(--card-dark); 
            display: flex; justify-content: center; align-items: center; 
            font-size: 1.5rem; 
            margin: 0 12px; 
            border: 2px solid var(--accent-color);
            box-shadow: 5px 5px 10px var(--neum-dark), -5px -5px 10px var(--neum-light);
            transition: transform 0.3s ease;
        }
        .user-avatar { color: #00FFFF; } 
        .ai-avatar { color: var(--highlight-color); } 


        .message {
            padding: 18px 25px; 
            border-radius: 30px; 
            max-width: 75%; 
            opacity: 0;
            transform: scale(0.95); 
            animation: bubbleIn 0.3s forwards ease-out;
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6); 
            line-height: 1.5; /* â¬…ï¸ FIX 1: Reduced from 1.7 to 1.5 */
            font-size: 1.05rem;
            direction: rtl; 
            text-align: right;
            padding-bottom: 30px; /* â¬…ï¸ FIX 3: Reduced from 35px to 30px */
        }
        
        /* â¬…ï¸ FIX 2: Added - Control spacing between paragraphs (Enter presses) */
        .message p {
            margin: 0; 
            padding: 0;
            margin-bottom: 8px; /* Standardize spacing between lines/paragraphs */
        }
        .message p:last-child {
            margin-bottom: 0; 
        }

        @keyframes bubbleIn { 
            0% { opacity: 0; transform: scale(0.8) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .user {
            background: var(--user-bubble); color: #FFF; 
            border-radius: 30px 10px 30px 30px;
            font-weight: 600;
        }
        .ai {
            background: var(--ai-bubble-bg); color: var(--text-color);
            border-radius: 10px 30px 30px 30px;
            box-shadow: 5px 5px 10px var(--neum-dark), -5px -5px 10px var(--neum-light);
        }
        
        .highlight {
            box-shadow: 0 0 15px 3px var(--highlight-color), 0 0 5px var(--highlight-color);
            border: 2px solid var(--highlight-color);
            transition: box-shadow 0.6s ease-out, border 0.6s ease-out;
        }

        /* ------------------ Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ Ú©Ù„ Ù¾ÛŒØ§Ù… ------------------ */
        .copy-btn {
            position: absolute; bottom: 10px; width: 25px; height: 25px;
            background: transparent; border: none; cursor: pointer;
            font-size: 1em; transition: color 0.2s, opacity 0.2s; opacity: 0.5;
        }

        .user .copy-btn { left: 15px; color: #FFF; } 
        .ai .copy-btn { right: 15px; color: var(--muted-text); }
        .copy-btn:hover { opacity: 1; color: var(--highlight-color); }
        .user .copy-btn:hover { color: #FFF; }
        
        .copy-success { color: #00FF00 !important; } 

        /* ------------------ Ú©Ø¯ Ø¨Ù„Ø§Ú© (Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡) ------------------ */
        code {
            direction: ltr; display: block; padding: 15px; background: var(--code-bg);
            border-radius: 10px; margin-top: 15px; overflow-x: auto;
            border-left: 5px solid var(--highlight-color); 
            font-size: 0.9em; color: var(--code-text); font-family: monospace;
            position: relative; 
            padding-top: 35px; 
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .code-copy-btn {
            position: absolute; top: 5px; left: 5px; right: unset; 
            background: rgba(255, 255, 255, 0.1); color: var(--muted-text);
            border: none; border-radius: 5px; cursor: pointer;
            font-size: 0.8em; padding: 5px 10px; opacity: 0.7;
            transition: opacity 0.2s, background 0.2s, color 0.2s;
            direction: rtl; 
            z-index: 5;
        }
        .code-copy-btn:hover { opacity: 1; background: rgba(3, 169, 244, 0.2); color: var(--highlight-color); }
        .code-copy-btn .fas { margin-left: 5px; }
        
        .loading {
            font-style: italic; opacity: 0.9; background: var(--ai-bubble-bg);
            padding-right: 5px; 
            animation: pulse 1s infinite alternate;
        }
        .loading::after {
            content: '_'; 
            animation: blink 1s infinite step-start;
        }
        @keyframes pulse { 
            0% { opacity: 0.8; transform: scale(0.99); } 
            100% { opacity: 1; transform: scale(1.01); } 
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        
        /* ------------------ ØªØµØ§ÙˆÛŒØ± AI Ø¯Ø± Ú†Øª ------------------ */
        .ai-image-container {
            display: flex; flex-direction: column; align-items: flex-end; width: 100%;
        }
        .ai-image {
            max-width: 95%; 
            max-height: 400px;
            margin: 10px 0 10px 0;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6), 0 0 15px 3px var(--highlight-color);
        }
        /* ---------------------------------------------------- */


        /* ======================================================= */
        /* âŒ¨ï¸ Input Area (Glassy)                                  */
        /* ======================================================= */
        #input-container {
            display: flex; background: var(--card-dark); padding: 15px; align-items: center;
            border: 1px solid var(--accent-color); border-radius: 25px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7); z-index: 20;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        #image-btn {
            width: 60px; height: 60px; border-radius: 50%;
            margin-left: 10px; 
            background: var(--bg-dark); 
            color: var(--highlight-color);
            font-size: 1.5rem;
            box-shadow: 5px 5px 10px var(--neum-dark), -5px -5px 10px var(--neum-light); 
            pointer-events: auto;
            opacity: 1;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        #image-btn:hover { color: #FFF; box-shadow: 0 0 10px var(--highlight-color); }
        #image-btn:active { 
            transform: scale(0.9); 
            box-shadow: inset 4px 4px 8px var(--neum-dark), inset -4px -4px 8px var(--neum-light); 
            color: #FFF;
        }


        #user-input {
            flex: 1; padding: 18px 25px; border: none; border-radius: 35px; outline: none;
            font-size: 1.1rem; 
            background: var(--bg-dark); color: var(--text-color);
            margin: 0 10px; 
            box-shadow: inset 5px 5px 10px var(--neum-dark), inset -5px -5px 10px var(--neum-light);
            direction: rtl;
            resize: none; 
            overflow-y: hidden; 
            max-height: 150px; 
            line-height: 1.5;
        }
        #user-input::placeholder { color: var(--muted-text); }
        #user-input:focus { 
            box-shadow: inset 0 0 15px rgba(3, 169, 244, 0.6); 
            border: 1px solid var(--highlight-color); 
        }

        .input-btn {
            width: 60px; height: 60px; border: none; border-radius: 50%; cursor: pointer;
            font-size: 1.5rem; color: #FFF; 
            background: linear-gradient(45deg, var(--highlight-color), #0077C0);
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.7), 0 0 8px rgba(3, 169, 244, 0.5); 
            transition: transform 0.1s ease, box-shadow 0.2s ease;
        }
        #send-btn:active { 
            background: #0077C0; 
            transform: scale(0.9); 
            box-shadow: inset 4px 4px 8px var(--neum-dark), inset -4px -4px 8px var(--neum-light), 0 0 15px rgba(3, 169, 244, 0.8); 
        }

        /* ======================================================= */
        /* ğŸŒŸ MOBILE OPTIMIZATION (ØªÙ†Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ú¯ÙˆØ´ÛŒ) */
        /* ======================================================= */
        @media (max-width: 600px) {
            :root {
                --avatar-size: 40px; 
                --border-radius: 12px;
            }
            #chat-app { padding: 10px; }
            #chat-header { padding: 15px 15px; font-size: 1.6rem; margin-bottom: 10px; }
            #chat-header button { width: 38px; height: 38px; font-size: 1rem; }
            #messages { 
                padding: 10px 5px; 
                margin-bottom: 10px; 
                border-radius: 15px; 
            }
            .message-container { margin: 8px 0; }
            .avatar { margin: 0 8px; font-size: 1.3rem; }
            .message {
                padding: 12px 18px; 
                border-radius: 20px; 
                max-width: 80%; 
                font-size: 0.9rem; 
                padding-bottom: 28px; 
            }
            .user { border-radius: 20px 8px 20px 20px; }
            .ai { border-radius: 8px 20px 20px 20px; }
            code { padding: 10px; font-size: 0.8em; padding-top: 30px; }
            .code-copy-btn { padding: 3px 8px; font-size: 0.7em; }
            .copy-btn { bottom: 6px; width: 20px; height: 20px; font-size: 0.85em; }
            .user .copy-btn { left: 10px; } 
            .ai .copy-btn { right: 10px; }
            #input-container { padding: 10px; border-radius: 20px; } 
            #user-input { 
                padding: 12px 20px; 
                font-size: 1rem; 
                max-height: 100px; 
            }
            .input-btn { width: 45px; height: 45px; font-size: 1.2rem; }
            #image-btn { width: 45px; height: 45px; font-size: 1.2rem; margin-left: 5px; }
        }
    </style>
</head>
<body>
    
<audio id="send-sound" src="https://assets.mixkit.co/sfx/download/mixkit-bell-notification-978.wav" preload="auto"></audio>
<audio id="bubble-sound" src="https://assets.mixkit.co/sfx/download/mixkit-bubble-pop-sound-2810.wav" preload="auto"></audio>

<div id="drawer">
    <div style="padding: 20px; font-size: 1.8rem; font-weight: 700; color: var(--highlight-color); text-align: center; border-bottom: 1px solid var(--accent-color); margin-bottom: 20px;">
        Ù…Ù†Ùˆ
    </div>
    
    <a href="{{ url_for('image_page') }}" class="drawer-link" style="color: var(--highlight-color); font-weight: 500;">
        <i class="fas fa-palette"></i> ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±
    </a>
    
    <span class="drawer-link disabled-link" title="Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯">
        <i class="fas fa-music"></i> ØªÙˆÙ„ÛŒØ¯ Ù…ÙˆØ³ÛŒÙ‚ÛŒ (<small>Ø¨Ø²ÙˆØ¯ÛŒ</small>)
    </span>

    <span class="drawer-link disabled-link" title="Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯">
        <i class="fas fa-gem"></i> Ø®Ø±ÛŒØ¯ Ù¾Ø±Ù…ÛŒÙˆÙ… (<small>Ø¨Ø²ÙˆØ¯ÛŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ú©Ø§ÙÙ‡ Ø¨Ø§Ø²Ø§Ø±</small>)
    </span>
    
    <hr style="margin: 10px 0; border-color: rgba(255, 255, 255, 0.1);">
    
    {% if logged_in %}
        <a href="{{ url_for('my_conversations') }}" class="drawer-link">
            <i class="fas fa-history"></i> Ø¢Ø±Ø´ÛŒÙˆ Ú¯ÙØªÚ¯Ùˆ
        </a>
        <a href="{{ url_for('account') }}" class="drawer-link">
            <i class="fas fa-user-circle"></i> Ø­Ø³Ø§Ø¨ Ù…Ù†
        </a>
    {% else %}
        <a href="{{ url_for('login') }}" class="drawer-link">
            <i class="fas fa-sign-in-alt"></i> **ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øª Ù†Ø§Ù…**
        </a>
    {% endif %}

    <a href="{{ url_for('support') }}" class="drawer-link">
        <i class="fas fa-hands-helping"></i> Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ
    </a>
    <a href="{{ url_for('about') }}" class="drawer-link">
        <i class="fas fa-info-circle"></i> Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§
    </a>

    {% if logged_in %}
        <a href="{{ url_for('logout') }}" class="drawer-link" style="color: #FF6666; margin-top: auto; border-top: 1px solid var(--accent-color);">
            <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
        </a>
    {% endif %}
</div>
<div id="drawer-backdrop"></div>

<div id="chat-app">
    <div id="chat-header">
        <button id="menu-btn" title="Ù…Ù†Ùˆ"><i class="fas fa-bars"></i></button> Cyrus
        
        <div id="header-controls">
            <button id="clear-btn" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú†Øª"><i class="fas fa-trash-alt"></i></button>
        </div>
    </div>
    
    <div id="messages">
        <div id="initial-prompt">
            Ú†Ø·ÙˆØ± Ù…ÛŒØªÙˆÙ†Ù… Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ù…ØŸ ğŸ¤”
        </div>
    </div>
    
    <div id="input-container">
        <button id="image-btn" class="input-btn" title="ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±" onclick="window.location.href='{{ url_for('image_page') }}';">
            <i class="fas fa-image"></i>
        </button>

        <textarea id="user-input" rows="1" placeholder=" Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
        
        <button id="send-btn" class="input-btn" title="Ø§Ø±Ø³Ø§Ù„"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script>
// Ø¹Ù†Ø§ØµØ± DOM
const input = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");
const clearBtn = document.getElementById("clear-btn");
const messages = document.getElementById("messages");
const sendSound = document.getElementById("send-sound");
const bubbleSound = document.getElementById("bubble-sound");
const initialPrompt = document.getElementById("initial-prompt"); 

// ğŸ’¡ Ø¹Ù†Ø§ØµØ± Ø¬Ø¯ÛŒØ¯ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø±
const menuBtn = document.getElementById("menu-btn");
const drawer = document.getElementById("drawer");
const backdrop = document.getElementById("drawer-backdrop");


/* ======================================================= */
/* ğŸ› ï¸ Utility & Setup                                     */
/* ======================================================= */

function setAppHeight() {
    document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
}
window.addEventListener('resize', setAppHeight);
window.addEventListener('orientationchange', setAppHeight);
setAppHeight();

// ğŸ’¡ Ø§Ø² LocalStorage Ø¨Ø±Ø§ÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ù…Ù‡Ù…Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
let chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]");

if (chatHistory.length > 0) {
    chatHistory.forEach(m => appendMessage(m.text, m.className, false, m.image_url)); 
    initialPrompt.style.display = 'none'; 
} else {
    initialPrompt.style.display = 'block'; 
}

function escapeHtml(str) {
    if (!str) return "";
    return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function playSendSound() {
    sendSound.currentTime = 0;
    sendSound.play().catch(e => console.log("Send sound play error:", e));
}

function playBubbleSound() {
    bubbleSound.currentTime = 0;
    bubbleSound.play().catch(e => console.log("Bubble sound play error:", e));
}

/** ğŸ› ï¸ ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ú©Ù¾ÛŒ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Textarea (Ø±ÙˆØ´ Ø³Ù†ØªÛŒ) */
function fallbackCopy(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    
    textarea.style.position = 'fixed';
    textarea.style.top = '0';
    textarea.style.left = '0';
    textarea.style.opacity = '0';
    
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (!successful) {
             console.error('Fallback copy failed!');
             alert("Ú©Ù¾ÛŒ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.");
        }
    } catch (err) {
        console.error('Fallback copy failed!', err);
        alert("Ú©Ù¾ÛŒ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.");
    }

    document.body.removeChild(textarea);
}

/** ğŸ”” Ù†Ù…Ø§ÛŒØ´ ÙÛŒØ¯Ø¨Ú© Ø¨ØµØ±ÛŒ Ù…ÙˆÙÙ‚ÛŒØª */
function feedback(button) {
    const originalIconClass = button.querySelector('i').className;
    button.querySelector('i').className = 'fas fa-check';
    button.classList.add('copy-success');

    setTimeout(() => {
        button.querySelector('i').className = originalIconClass;
        button.classList.remove('copy-success');
    }, 1000);
}

function copyMessage(button, textToCopy) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textToCopy).then(() => {
            feedback(button);
        }).catch(() => {
            fallbackCopy(textToCopy);
            feedback(button);
        });
        return; 
    } else {
        fallbackCopy(textToCopy);
        feedback(button);
    }
}


/* ======================================================= */
/* ğŸ§­ DRAWER / SWIPE LOGIC (Ù…Ù†Ø·Ù‚ Ú©Ø´ÙˆÛŒÛŒ) */
/* ======================================================= */

function openDrawer() {
    drawer.classList.add('open');
}

function closeDrawer() {
    drawer.classList.remove('open');
}

menuBtn.addEventListener('click', openDrawer);
backdrop.addEventListener('click', closeDrawer);

// ** Ù…Ù†Ø·Ù‚ ØªØ´Ø®ÛŒØµ Ú©Ø´ÛŒØ¯Ù† (Swipe Detection) **
let touchStartX = 0;

document.addEventListener('touchstart', (e) => {
    // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªÚ© Ù„Ù…Ø³ Ùˆ Ø§Ø² Ø³Ù…Øª Ø±Ø§Ø³Øª ØµÙØ­Ù‡ (70% Ø¹Ø±Ø¶ ØµÙØ­Ù‡)
    if (e.touches.length === 1 && e.touches[0].clientX > window.innerWidth * 0.7) {
        touchStartX = e.touches[0].clientX;
    } else {
        touchStartX = 0;
    }
}, { passive: true }); 

document.addEventListener('touchend', (e) => {
    if (touchStartX === 0) return;
    
    const touchEndX = e.changedTouches[0].clientX;
    const distance = touchStartX - touchEndX; 

    // ğŸ’¡ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù†: Ø§Ú¯Ø± ÙØ§ØµÙ„Ù‡ Ø­Ø±Ú©Øª Ø¨Ù‡ Ø³Ù…Øª Ú†Ù¾ (ÙØ§ØµÙ„Ù‡ Ù…Ø«Ø¨Øª) Ø¨ÛŒØ´ØªØ± Ø§Ø² 80 Ù¾ÛŒÚ©Ø³Ù„ Ø¨Ø§Ø´Ø¯
    if (distance > 80) { 
        openDrawer();
    } 
    // ğŸ’¡ Ø¨Ø³ØªÙ†: Ø§Ú¯Ø± Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¨Ø§Ø² Ø§Ø³Øª Ùˆ Ø§Ø² Ú†Ù¾ Ø¨Ù‡ Ø±Ø§Ø³Øª Ú©Ø´ÛŒØ¯Ù‡ Ø´ÙˆØ¯ (ÙØ§ØµÙ„Ù‡ Ù…Ù†ÙÛŒ)
    else if (drawer.classList.contains('open') && distance < -80) {
        closeDrawer();
    }

    touchStartX = 0; 
}, { passive: true });


/* ======================================================= */
/* ğŸ’¬ Messaging Logic                                      */
/* ======================================================= */

function appendMessage(text, className, highlight = true, imageUrl = null) {
    if (initialPrompt.style.display !== 'none') {
        initialPrompt.style.display = 'none';
    }

    const container = document.createElement("div");
    container.classList.add("message-container", `${className}-container`);

    const msg = document.createElement("div");
    msg.classList.add("message", className);
    
    // 1. Ø³Ø§Ø®Øª Ø¢ÙˆØ§ØªØ§Ø±
    const avatar = document.createElement("div");
    avatar.classList.add("avatar", `${className}-avatar`);
    avatar.innerHTML = className === 'user' ? '<i class="fas fa-hat-cowboy"></i>' : '<i class="fas fa-brain"></i>';
    
    // 2. Ø³Ø§Ø®Øª Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ Ú©Ù„ Ù¾ÛŒØ§Ù…
    const copyButton = document.createElement("button");
    copyButton.classList.add("copy-btn");
    copyButton.innerHTML = '<i class="fas fa-copy"></i>';
    copyButton.addEventListener('click', () => copyMessage(copyButton, text));
    
    // 3. Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÛŒØ§Ù… (Ú©Ø¯ Ùˆ Ù…ØªÙ†)
    if (text.includes("```")) {
        const parts = text.split(/```/);
        msg.innerHTML = "";
        for (let i = 0; i < parts.length; i++) {
            if (i % 2 === 0) {
                const formatted = parts[i].trim().split('\n').map(p => {
                    p = escapeHtml(p);
                    p = p.replace(/\*\*(.+?)\*\*/g, "<b>$1</b>");
                    p = p.replace(/__(.+?)__/g, "<i>$1</i>");
                    return p ? `<p>${p}</p>` : '';
                }).join('');
                msg.insertAdjacentHTML('beforeend', formatted);
            } else {
                const codeText = parts[i].replace(/^\s*\w+\n?/, "").trim(); 
                const codeBlock = document.createElement("code");
                codeBlock.textContent = codeText;
                
                const codeCopyBtn = document.createElement("button");
                codeCopyBtn.classList.add("code-copy-btn");
                codeCopyBtn.innerHTML = '<i class="fas fa-copy"></i>Ú©Ù¾ÛŒ Ú©Ø¯';
                codeCopyBtn.addEventListener('click', () => copyMessage(codeCopyBtn, codeText));
                
                codeBlock.prepend(codeCopyBtn); 
                msg.appendChild(codeBlock);
            }
        }
    } else {
        // Ù…Ù†Ø·Ù‚ Ø¨Ø±Ø§ÛŒ Ù…ØªÙ† Ø¹Ø§Ø¯ÛŒ
        const formatted = text.trim().split('\n').map(p => {
            p = escapeHtml(p);
            p = p.replace(/\*\*(.+?)\*\*/g, "<b>$1</b>");
            p = p.replace(/__(.+?)__/g, "<i>$1</i>");
            return p ? `<p>${p}</p>` : '';
        }).join('');
        msg.insertAdjacentHTML('beforeend', formatted);
    }
    
    // 4. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØµÙˆÛŒØ± (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ Ùˆ Ù¾ÛŒØ§Ù… Ø§Ø² AI Ø§Ø³Øª)
    if (className === 'ai' && imageUrl) {
        const imageWrapper = document.createElement('div');
        imageWrapper.classList.add('ai-image-container');
        
        const imageElement = document.createElement('img');
        imageElement.src = imageUrl;
        imageElement.alt = "ØªØµÙˆÛŒØ± ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· AI";
        imageElement.classList.add('ai-image');
        
        imageWrapper.appendChild(imageElement);
        msg.appendChild(imageWrapper);
        
        imageElement.onload = () => {
             messages.scrollTop = messages.scrollHeight;
        };
    }
    
    // 5. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ Ú©Ù„ Ù¾ÛŒØ§Ù…
    msg.appendChild(copyButton);

    // 6. Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø¢ÙˆØ§ØªØ§Ø± Ùˆ Ù¾ÛŒØ§Ù… Ø¯Ø± Ú©Ø§Ù†ØªÛŒÙ†Ø±
    if (className === 'user') {
        container.appendChild(msg);
        container.appendChild(avatar);
    } else {
        container.appendChild(avatar);
        container.appendChild(msg);
    }

    messages.appendChild(container);

    if (className !== 'loading') { 
        messages.scrollTop = messages.scrollHeight;

        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
        chatHistory.push({ text, className, image_url: imageUrl }); 
        localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    }
    
    // Ø§ÙÚ©Øª Ù‡Ø§ÛŒÙ„Ø§ÛŒØª
    if (highlight) {
        msg.classList.add("highlight");
        setTimeout(() => msg.classList.remove("highlight"), 800);
    }

    // Ù…Ø¯ÛŒØ±ÛŒØª Ø·ÙˆÙ„ ØªØ§Ø±ÛŒØ®Ú†Ù‡
    while (messages.children.length > 50) {
        messages.removeChild(messages.children[0]);
        chatHistory.shift();
        localStorage.removeItem("chatHistory");
    }
}


// Ø­Ø¨Ø§Ø¨ Ù„ÙˆØ¯ÛŒÙ†Ú¯
function showLoadingBubble() {
    if (initialPrompt.style.display !== 'none') {
        initialPrompt.style.display = 'none';
    }

    const container = document.createElement("div");
    container.classList.add("message-container", "ai-container");

    const avatar = document.createElement("div");
    avatar.classList.add("avatar", "ai-avatar");
    avatar.innerHTML = '<i class="fas fa-brain"></i>';
    container.appendChild(avatar);

    const bubble = document.createElement("div");
    bubble.classList.add("message", "ai", "loading");
    bubble.textContent = "... Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†";
    container.appendChild(bubble);

    messages.appendChild(container);
    messages.scrollTop = messages.scrollHeight;
    
    return { container, bubble };
}

// -------------------------------------------------------------------
// ğŸ¯ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¨Ú©â€ŒØ§Ù†Ø¯ Flask
// -------------------------------------------------------------------

async function sendMessage() {
    const message = input.value.trim();
    if (!message) return;
    
    sendBtn.disabled = true;
    input.disabled = true;
    
    appendMessage(message, "user");
    playSendSound(); 

    // Ù…Ù‡Ù…: Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…ØŒ Ø§Ø±ØªÙØ§Ø¹ input Ø±Ø§ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒØ¯.
    input.value = "";
    input.style.height = 'auto'; // ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬Ø¯Ø¯ Ø§Ø±ØªÙØ§Ø¹

    const { container: loadingContainer, bubble: loadingElem } = showLoadingBubble();

    try {
        const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: message })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        const responseText = data.reply || "Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù¾Ø§Ø³Ø®ÛŒ Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.";
        
        const imageUrl = data.image_url || null;


        loadingElem.textContent = "";
        loadingElem.classList.remove("loading"); 

        let i = 0;
        const interval = setInterval(() => {
            if (i < responseText.length) {
                loadingElem.textContent += responseText.charAt(i); 
                i++;
                messages.scrollTop = messages.scrollHeight; 
            } else {
                clearInterval(interval);
                messages.removeChild(loadingContainer);
                appendMessage(loadingElem.textContent, "ai", true, imageUrl);
                playBubbleSound();
                
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
                
                // Ø§Ø³Ú©Ø±ÙˆÙ„ Ù…Ø¬Ø¯Ø¯ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
                autoGrowTextarea();
            }
        }, 20); 

    } catch (error) {
        console.error("Fetch error:", error);
        messages.removeChild(loadingContainer);
        appendMessage(`**Ø®Ø·Ø§:** ${error.message} (Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.)`, "ai");
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
        
        // Ø§Ø³Ú©Ø±ÙˆÙ„ Ù…Ø¬Ø¯Ø¯ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
        autoGrowTextarea();
    }
}


/* ======================================================= */
/* ğŸ“ˆ Textarea Auto-Grow Logic (Ù…Ù†Ø·Ù‚ Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø±ØªÙØ§Ø¹)       */
/* ======================================================= */

function autoGrowTextarea() {
    // 1. Ø§Ø±ØªÙØ§Ø¹ Ø±Ø§ Ù…ÙˆÙ‚ØªØ§Ù‹ Ø¨Ù‡ Ø­Ø¯Ø§Ù‚Ù„ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒØ¯
    input.style.height = 'auto'; 

    // 2. Ø§Ø±ØªÙØ§Ø¹ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø­ØªÙˆØ§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯
    let newHeight = input.scrollHeight;

    // 3. Ø§Ø¹Ù…Ø§Ù„ Ø§Ø±ØªÙØ§Ø¹ Ø¬Ø¯ÛŒØ¯
    input.style.height = newHeight + 'px';

    // 4. Ø§Ø³Ú©Ø±ÙˆÙ„ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø¢Ø®Ø±ÛŒÙ† Ù¾ÛŒØ§Ù… Ø¯Ø± Ù„ÛŒØ³Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
    messages.scrollTop = messages.scrollHeight; 

    // ğŸ’¡ Ú¯Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„: Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ø´ÙˆØ¯ Ú©Ù‡ Input Ø¯Ø± Ø¯ÛŒØ¯ Ø¨Ø§Ù‚ÛŒ Ø¨Ù…Ø§Ù†Ø¯
    input.scrollIntoView({ behavior: 'smooth', block: 'end' });
}


// -------------------------------------------------------------------
// ğŸš¦ Event Listeners (Ø§Ø¬Ø±Ø§ Ú©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø±ÙˆÛŒØ¯Ø§Ø¯)
// -------------------------------------------------------------------

sendBtn.addEventListener("click", sendMessage);

// Event Listener Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±ØªÙØ§Ø¹ Ù‡Ù†Ú¯Ø§Ù… ØªØ§ÛŒÙ¾
input.addEventListener("input", autoGrowTextarea); 

// Event Listener Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ÙÙˆÚ©ÙˆØ³ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ (Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¯ÛŒØ¯Ù‡ Ø´Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„)
input.addEventListener("focus", () => {
    // Ú©Ù…ÛŒ ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¨Ø§Ù„Ø§ Ø¢Ù…Ø¯Ù† Ú©Ø§Ù…Ù„ Ú©ÛŒØ¨ÙˆØ±Ø¯
    setTimeout(() => {
        // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ø´ÙˆØ¯ Ú©Ù‡ Ú©Ø§Ù†ØªÛŒÙ†Ø± ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ù†Ù…Ø§ÛŒ Ø¯ÛŒØ¯ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø´ÙˆØ¯
        document.getElementById("input-container").scrollIntoView({ 
            behavior: 'smooth', 
            block: 'end' 
        });
    }, 100); 
});

input.addEventListener("keypress", (event) => {
    // Ø¨Ø±Ø§ÛŒ textareaØŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø§ÛŒØ¯ Ø¬Ù„ÙˆÛŒ Ø®Ø· Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ú¯ÛŒØ±ÛŒÙ….
    if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault(); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø· Ø¬Ø¯ÛŒØ¯
        sendMessage();
    }
});

clearBtn.addEventListener("click", () => {
    if (confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú©Ù„ Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ")) {
        messages.innerHTML = `<div id="initial-prompt">Ú†Ø·ÙˆØ± Ù…ÛŒØªÙˆÙ†Ù… Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ù…ØŸ ğŸ¤”</div>`;
        initialPrompt.style.display = 'block';
        localStorage.removeItem("chatHistory");
        chatHistory = []; 
        alert("Ú¯ÙØªÚ¯Ùˆ Ù¾Ø§Ú© Ø´Ø¯.");
        // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø§Ø±ØªÙØ§Ø¹ textarea Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡ Ù¾Ø³ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú†Øª
        input.style.height = 'auto';
    }
});
</script>
</body>
</html>