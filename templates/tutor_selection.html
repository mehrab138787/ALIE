<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¹Ù„Ù… ØªØ®ØµØµÛŒ - Cyrus AI</title>
    
    <!-- ğŸ¨ Dark Mode Ùˆ Ø§Ø³ØªØ§ÛŒÙ„ Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ -->
    <style>
        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ Ùˆ Dark Mode */
        body {
            font-family: Tahoma, sans-serif;
            background-color: #121212; /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø³ÛŒØ§Ù‡ ØªÛŒØ±Ù‡ */
            color: #e0e0e0; /* Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ø³ÙÛŒØ¯/Ø±ÙˆØ´Ù† */
            margin: 0;
            padding: 0;
            direction: rtl;
        }
        .container {
            width: 95%; /* Ú©Ù…ÛŒ Ù¾Ù‡Ù†â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
            max-width: 1000px;
            margin: 20px auto;
            padding: 15px;
        }
        h1 {
            color: #ffffff;
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333; /* Ø®Ø· Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ ØªÛŒØ±Ù‡ */
        }
        
        /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ù„Ù…ÛŒÙ† */
        .tutor-card {
            border: 1px solid #3a3a3a; /* Ø­Ø§Ø´ÛŒÙ‡ Ú©Ø§Ø±Øª ØªÛŒØ±Ù‡ */
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            background-color: #1e1e1e; /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ú©Ø§Ø±Øª Ú©Ù…ÛŒ Ø±ÙˆØ´Ù†â€ŒØªØ± Ø§Ø² Ø¨Ø¯Ù†Ù‡ */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .tutor-card.activated {
            border-left: 6px solid #00ff41; /* ÙØ¹Ø§Ù„: Ø³Ø¨Ø² Ø±ÙˆØ´Ù† (Ú©Ù†ØªØ±Ø§Ø³Øª Ø¨Ø§Ù„Ø§) */
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
        }
        .tutor-card.daily-use {
            border-left: 6px solid #ffcc00; /* Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡: Ø²Ø±Ø¯/Ù†Ø§Ø±Ù†Ø¬ÛŒ */
        }
        
        .tutor-info h3 {
            margin-top: 0;
            color: #ffffff;
            font-size: 1.1em;
        }
        .tutor-info h3 small {
            color: #aaaaaa;
            font-size: 0.75em;
        }
        .price-info {
            margin-top: 8px;
            font-size: 0.85em;
            color: #cccccc;
        }
        .price-permanent {
            color: #ffffff;
            font-weight: bold;
        }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn-action {
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            color: #ffffff; /* Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø³ÙÛŒØ¯ */
            font-weight: bold;
            transition: opacity 0.2s;
            border: none;
            font-size: 0.9em;
            margin-left: 8px;
        }
        .btn-activate {
            background-color: #ffcc00; /* Ø²Ø±Ø¯ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ù¾ÙˆÙ„ */
            color: #1a1a1a;
        }
        .btn-activate:hover { background-color: #e6b800; }
        
        .btn-daily {
            background-color: #3a3a3a; /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ ØªÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ù…ØªÛŒØ§Ø² */
            border: 1px solid #555555;
        }
        .btn-daily:hover { opacity: 0.8; }

        /* Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ùˆ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ */
        .alert {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9em;
        }
        .alert-success {
            color: #d4edda;
            background-color: #155724;
            border-color: #155724;
        }
        .alert-info {
            color: #cce5ff;
            background-color: #0c5460;
            border-color: #0c5460;
        }
        .alert-danger {
            color: #f8d7da;
            background-color: #721c24;
            border-color: #721c24;
        }

        /* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ (Ø¨Ø±Ø§ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ ØµÙØ­Ù‡ Ø¨Ø²Ø±Ú¯ØªØ± Ø´ÙˆØ¯ØŒ ÙÙ‚Ø· Ø­Ø§Ø´ÛŒÙ‡ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯) */
        @media (min-width: 768px) {
            .container {
                padding: 30px;
            }
            .tutor-info h3 {
                font-size: 1.3em;
            }
            .btn-action {
                padding: 10px 20px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¹Ù„Ù… ØªØ®ØµØµÛŒ</h1>

    {% if payment_success_msg %}
    <div class="alert alert-success" role="alert">
        <strong>âœ¨ Ù…ÙˆÙÙ‚ÛŒØª!</strong> {{ payment_success_msg }}
    </div>
    {% endif %}

    {% if selected_tutor %}
    <div class="alert alert-info" role="alert">
        <strong>âœ… Ù…Ø¹Ù„Ù… Ø§Ù…Ø±ÙˆØ²:</strong> Ø´Ù…Ø§ Ø§Ù…Ø±ÙˆØ² Ø§Ø² Ù…Ø¹Ù„Ù… <strong>{{ selected_tutor }}</strong> Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.
    </div>
    {% endif %}

    <div id="tutor-list">
        {% for tutor in tutor_data_list %}
        <div class="tutor-card" id="card-{{ tutor.lang_code }}">
            <div class="tutor-info">
                <h3>
                    {{ tutor.name }} ({{ tutor.lang_code | upper }})
                    <small style="float: left; color: #aaaaaa;">{{ tutor.description }}</small>
                </h3>
                <div class="price-info">
                    <p>
                        <strong>ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¦Ù…ÛŒ:</strong> 
                        <span class="price-permanent">{{ tutor.permanent_price_fa }} ØªÙˆÙ…Ø§Ù†</span>
                        | <strong>Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡:</strong> {{ tutor.daily_cost }} Ø§Ù…ØªÛŒØ§Ø²
                    </p>
                </div>
            </div>
            
            <div id="action-area-{{ tutor.lang_code }}">
                <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ ØªÙˆØ³Ø· Ø¬Ø§ÙˆØ§ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ù‡â€ŒØ±ÙˆØ² Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                <p style="color: #777;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª...</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ØªØ¨Ø¯ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø§Ø² Ø¨Ú©â€ŒØ§Ù†Ø¯ Ø¨Ù‡ Ø¢Ø¨Ø¬Ú©Øª Ø¬Ø§ÙˆØ§ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
    const tutorData = JSON.parse('{{ tutor_data_list | tojson | safe }}');
    const userLoggedIn = {{ 'true' if logged_in else 'false' }};

    if (!userLoggedIn) {
        document.querySelectorAll('[id^="action-area-"]').forEach(el => {
            el.innerHTML = '<p class="text-danger" style="color: #f8d7da;">âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø§Ù…Ú©Ø§Ù†Ø§Øª <a href="{{ url_for(\'login\') }}" style="color: #cce5ff;">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a>.</p>';
        });
        return;
    }

    // --- ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI ---
    function fetchTutorStatus(langCode) {
        // Ù…Ø³ÛŒØ± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª
        fetch("{{ url_for('tutor_status_api', lang_code='TEMP_CODE') }}".replace('TEMP_CODE', langCode), {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            const actionArea = document.getElementById(`action-area-${langCode}`);
            const card = document.getElementById(`card-${langCode}`);
            const tutorInfo = tutorData.find(t => t.lang_code === langCode);

            if (data.status === 'error') {
                actionArea.innerHTML = `<p class="alert alert-danger">Ø®Ø·Ø§: ${data.message}</p>`;
                return;
            }

            const isActivated = data.is_activated;
            const canUseDaily = data.can_use_daily;

            let htmlContent = '';
            card.classList.remove('activated', 'daily-use'); // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§

            if (isActivated) {
                // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¦Ù…ÛŒ (ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø³Ø±ÙˆØ±)
                card.classList.add('activated');
                htmlContent = `<p style="color: #00ff41;">âœ… Ø§ÛŒÙ† Ù…Ø¹Ù„Ù… Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§Ø¦Ù…ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ø§Ø³Øª.</p>`;
            } else if (data.is_using_today) {
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ ÙØ¹Ø§Ù„ Ø§Ø³Øª (Ø§Ù…Ø±ÙˆØ² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡)
                card.classList.add('daily-use');
                htmlContent = `<p style="color: #ffcc00;">â³ Ø´Ù…Ø§ Ø§Ù…Ø±ÙˆØ² Ø§Ø² Ø§ÛŒÙ† Ù…Ø¹Ù„Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.</p>`;
            } else if (canUseDaily) {
                // Ø§Ù…Ú©Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ (Ø¨Ø§ Ø§Ù…ØªÛŒØ§Ø²)
                htmlContent = `
                    <button class="btn-action btn-daily" onclick="useTutorDaily('${langCode}', '${tutorInfo.daily_cost}')">
                        Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ (${tutorInfo.daily_cost} Ø§Ù…ØªÛŒØ§Ø²)
                    </button>
                    <button class="btn-action btn-activate" onclick="activateTutor('${langCode}', '${tutorInfo.permanent_price_fa}')">
                        ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¦Ù…ÛŒ (Ø®Ø±ÛŒØ¯)
                    </button>
                `;
            } else {
                // Ù‡ÛŒÚ†Ú©Ø¯Ø§Ù…: Ø¨ÙˆØ¯Ø¬Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡
                htmlContent = `<p class="alert alert-danger">â›” Ø¨ÙˆØ¯Ø¬Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                               <button class="btn-action btn-activate" onclick="activateTutor('${langCode}', '${tutorInfo.permanent_price_fa}')">
                                   ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¦Ù…ÛŒ (Ø®Ø±ÛŒØ¯)
                               </button>`;
            }

            actionArea.innerHTML = htmlContent;
        })
        .catch(error => {
            console.error('Error fetching status for:', langCode, error);
            document.getElementById(`action-area-${langCode}`).innerHTML = '<p class="alert alert-danger">Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª.</p>';
        });
    }

    // --- ØªÙˆØ§Ø¨Ø¹ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¨Ú©â€ŒØ§Ù†Ø¯ ---
    
    // 1. ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ Ø¯Ø§Ø¦Ù…ÛŒ (Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù‚Ø¹ÛŒ) - **Ø¨Ø¯ÙˆÙ† Ú©Ø³Ø± Ø§Ù…ØªÛŒØ§Ø²**
    window.activateTutor = function(langCode, priceFa) {
        if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù…Ø¹Ù„Ù… ${langCode} Ø±Ø§ Ø¨Ø§ Ù‚ÛŒÙ…Øª ${priceFa} ØªÙˆÙ…Ø§Ù† Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§Ø¦Ù…ÛŒ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯ØŸ Ø§ÛŒÙ† Ú©Ø§Ø± Ø´Ù…Ø§ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù‡Ø¯Ø§ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ú©Ø³Ø± Ù†Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.`)) {
            return;
        }
        // Ù…Ø³ÛŒØ± Ø¨Ù‡ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª
        window.location.href = "{{ url_for('activate_tutor_api', lang_code='TEMP_CODE') }}".replace('TEMP_CODE', langCode);
    };

    // 2. Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ (Ú©Ø³Ø± Ø§Ù…ØªÛŒØ§Ø²)
    window.useTutorDaily = function(langCode, cost) {
         if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ù…Ø¹Ù„Ù… ${langCode} Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ØŸ ${cost} Ø§Ù…ØªÛŒØ§Ø² Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø´Ù…Ø§ Ú©Ø³Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯.`)) {
            return;
        }
        // Ù…Ø³ÛŒØ± Ú©Ø³Ø± Ø§Ù…ØªÛŒØ§Ø² Ø±ÙˆØ²Ø§Ù†Ù‡
        fetch("{{ url_for('use_tutor_daily_api', lang_code='TEMP_CODE') }}".replace('TEMP_CODE', langCode), {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                // Ù¾Ø³ Ø§Ø² Ù…ÙˆÙÙ‚ÛŒØªØŒ ÙˆØ¶Ø¹ÛŒØª ØµÙØ­Ù‡ Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                window.location.reload();
            } else {
                alert('Ø®Ø·Ø§: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error using daily tutor:', error);
            alert('Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø±Ø® Ø¯Ø§Ø¯.');
        });
    };

    // --- Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
    tutorData.forEach(tutor => {
        fetchTutorStatus(tutor.lang_code);
    });
});
</script>

</body>
</html>
