<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ£ÛŒÛŒØ¯ Ú©Ø¯ Ù¾ÛŒØ§Ù…Ú©ÛŒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø±Ù†Ú¯ */
        :root {
            --bg-dark: #070707; 
            --card-dark: #1e1e1e; 
            --highlight-color: #00CC66; /* Ø³Ø¨Ø² Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ */
            --highlight-color-light: #39e68c;
            --text-color: #FAFAFA; 
            --error-color: #FF4444; 
            --success-color: #00CC66;
            --border-radius: 16px;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Vazirmatn', sans-serif;}
        body { 
            background: var(--bg-dark); 
            color: var(--text-color); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 20px;
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø§Ø±Øª Ø¨Ø§ Ø³Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÛŒÙ‚ */
        .verify-card { 
            background: var(--card-dark); 
            padding: 35px; 
            border-radius: var(--border-radius);
            width: 90%; 
            max-width: 450px; 
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.7), 
                0 0 0 1px rgba(255, 255, 255, 0.05);
            direction: rtl;
            transition: all 0.3s ease-in-out;
        }

        .verify-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 50px rgba(0, 0, 0, 0.8);
        }

        .verify-card h2 { 
            text-align: center; 
            color: var(--highlight-color); 
            margin-bottom: 10px; 
            font-size: 1.8rem;
        }
        
        .verify-card p { 
            text-align: center; 
            margin-bottom: 30px; 
            font-size: 1rem; 
            color: #ccc; 
        }

        /* ğŸ’¥ Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø§Ù†ØªÛŒÙ†Ø± Û¶ Ú©Ø§Ø¯Ø± ÙˆØ±ÙˆØ¯ÛŒ (OTP Container) */
        .otp-container {
            display: flex;
            justify-content: space-between;
            gap: 8px; /* Ø§ÙØ²Ø§ÛŒØ´ ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ú©Ø§Ø¯Ø±Ù‡Ø§ */
            margin-bottom: 30px;
            direction: ltr; /* Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø² Ú†Ù¾ Ø¨Ù‡ Ø±Ø§Ø³Øª */
        }

        /* ğŸ’¥ Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø§Ø¯Ø±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ù…Ø¬Ø²Ø§ - Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        .otp-container input {
            width: 14%; /* Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¬Ø§ Ø´Ø¯Ù† Û¶ Ú©Ø§Ø¯Ø± + gap Ø¯Ø± Ø¹Ø±Ø¶ Û±Û°Û°Ùª */
            height: auto;
            aspect-ratio: 1 / 1; /* Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù…Ø±Ø¨Ø¹ÛŒ Ø¨ÙˆØ¯Ù† Ú©Ø§Ø¯Ø± */
            max-width: 55px; /* Ø­Ø¯Ø§Ú©Ø«Ø± Ø¹Ø±Ø¶ Ø¯Ø± Ø¯Ø³Ú©ØªØ§Ù¾ */
            max-height: 65px; /* Ø­Ø¯Ø§Ú©Ø«Ø± Ø§Ø±ØªÙØ§Ø¹ Ø¯Ø± Ø¯Ø³Ú©ØªØ§Ù¾ */
            
            padding: 5px; /* Ù¾Ø¯ÛŒÙ†Ú¯ Ø¯Ø§Ø®Ù„ÛŒ Ú©Ù…ØªØ± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ± Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
            border: 2px solid #333; 
            border-radius: 10px; 
            background: #2a2a2a; 
            color: var(--text-color); 
            font-size: 1.5rem; /* ÙÙˆÙ†Øª Ø¨Ø²Ø±Ú¯ Ùˆ Ø®ÙˆØ§Ù†Ø§ */
            font-weight: 700;
            text-align: center; 
            outline: none; 
            transition: all 0.2s ease-in-out;
            -moz-appearance: textfield;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.4); 
        }

        /* Ø­Ø°Ù ÙÙ„Ø´â€ŒÙ‡Ø§ÛŒ Ø¹Ø¯Ø¯ÛŒ */
        .otp-container input::-webkit-outer-spin-button,
        .otp-container input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Ø§ÙÚ©Øª Focus Ring */
        .otp-container input:focus { 
            border-color: var(--highlight-color); 
            box-shadow: 0 0 0 3px rgba(0, 204, 102, 0.3); /* Focus Glow */
            background: #333;
            transform: scale(1.05);
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ */
        button { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 10px; 
            background: var(--highlight-color); 
            color: var(--bg-dark); 
            font-size: 1.2rem; 
            font-weight: 700; 
            cursor: pointer; 
            transition: background-color 0.3s, opacity 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 4px 20px rgba(0, 204, 102, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        button:hover:not(:disabled) { 
            background: var(--highlight-color-light); 
            transform: translateY(-2px); 
            box-shadow: 0 6px 25px rgba(0, 204, 102, 0.6);
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .status-message { margin-top: 20px; padding: 12px; border-radius: 10px; text-align: center; }
        .status-message.error { background: rgba(255, 68, 68, 0.2); color: var(--error-color); }
        .status-message.success { background: rgba(0, 204, 102, 0.2); color: var(--success-color); }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ (Resend) */
        .resend-link { 
            display: block; 
            text-align: center; 
            margin-top: 25px; 
            color: #aaa; 
            text-decoration: none; 
            font-size: 0.95rem; 
            cursor: pointer; 
            transition: color 0.2s;
        }
        .resend-link:hover:not(.disabled) { color: var(--text-color); }
        .resend-link.disabled { opacity: 0.6; cursor: default; }

        /* ğŸ’¥ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        @media (max-width: 400px) {
            .verify-card { 
                padding: 25px; 
                width: 95%; /* Ù¾Ù‡Ù†Ø§ÛŒ Ø¨ÛŒØ´ØªØ±ÛŒ Ø§Ø² Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø±Ø§ Ø¨Ú¯ÛŒØ±Ø¯ ØªØ§ Ú©Ø§Ø¯Ø±Ù‡Ø§ Ø¬Ø§ Ø´ÙˆÙ†Ø¯ */
            }
            .otp-container {
                gap: 5px; /* Ú©Ø§Ù‡Ø´ ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ú©Ø§Ø¯Ø±Ù‡Ø§ */
            }
            .otp-container input {
                font-size: 1.3rem;
                width: 13vw; /* Ú©Ù…ÛŒ Ú©ÙˆÚ†Ú©â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ø¬Ø§ Ø´Ø¯Ù† Ø¯Ø± Ú©Ù†Ø§Ø± Ù‡Ù… */
            }
            .verify-card h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<div class="verify-card">
    <h2><i class="fas fa-lock"></i> ØªØ£ÛŒÛŒØ¯ Ú©Ø¯ Ù¾ÛŒØ§Ù…Ú©ÛŒ</h2>
    <p>Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ <strong id="user-phone"></strong> Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</p>
    
    <!-- ğŸ’¥ Ú©Ø§Ù†ØªÛŒÙ†Ø± Û¶ Ú©Ø§Ø¯Ø± ÙˆØ±ÙˆØ¯ÛŒ -->
    <div class="otp-container" id="otp-container">
        <input type="text" id="code-1" maxlength="1" inputmode="numeric">
        <input type="text" id="code-2" maxlength="1" inputmode="numeric">
        <input type="text" id="code-3" maxlength="1" inputmode="numeric">
        <input type="text" id="code-4" maxlength="1" inputmode="numeric">
        <input type="text" id="code-5" maxlength="1" inputmode="numeric">
        <input type="text" id="code-6" maxlength="1" inputmode="numeric">
    </div>
    
    <button id="verify-btn" onclick="verifyCode()">
        <i class="fas fa-sign-in-alt"></i> ØªØ£ÛŒÛŒØ¯ Ùˆ ÙˆØ±ÙˆØ¯
    </button>
    
    <div id="status-message" class="status-message" style="display:none;"></div>

    <a id="resend-link" onclick="resendCode()" class="resend-link">
        <i class="fas fa-redo"></i> Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Ú©Ø¯
    </a>
</div>

<script>
    const otpContainer = document.getElementById('otp-container');
    const inputFields = Array.from(otpContainer.querySelectorAll('input'));
    const verifyBtn = document.getElementById('verify-btn');
    const statusDiv = document.getElementById('status-message');
    const userPhoneSpan = document.getElementById('user-phone');
    const resendLink = document.getElementById('resend-link');
    
    // ğŸ’¡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø§Ø² Local Storage
    const userPhone = localStorage.getItem('phone_for_verification');

    if (userPhone) {
        userPhoneSpan.textContent = userPhone.substring(0, 4) + '***' + userPhone.substring(7); // Ù†Ù…Ø§ÛŒØ´ Ù…Ø§Ø³Ú© Ø´Ø¯Ù‡
    } else {
        userPhoneSpan.textContent = "Ù†Ø§Ù…Ø´Ø®Øµ";
        // Ù‡Ø¯Ø§ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ ØµÙØ­Ù‡ Ù„Ø§Ú¯ÛŒÙ† Ø§Ú¯Ø± Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
        setTimeout(() => { window.location.href = '/login_phone'; }, 1000);
    }

    function showStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = 'status-message ' + type;
        statusDiv.style.display = 'block';
    }

    // ğŸ’¥ Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø±Ú©Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Backspace
    inputFields.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            // ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯ Ø±Ø§ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±Ø¯
            e.target.value = e.target.value.replace(/\D/g, ''); 
            
            // Ø§Ú¯Ø± Ú©Ø§Ø±Ø§Ú©ØªØ±ÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯ Ùˆ Ú©Ø§Ø¯Ø± Ù¾Ø± Ø´Ø¯
            if (e.target.value.length === 1 && index < inputFields.length - 1) {
                inputFields[index + 1].focus();
            }
            
            // Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ú©Ø§Ø¯Ø±Ù‡Ø§ Ù¾Ø± Ø´Ø¯Ù†Ø¯ØŒ Ø¯Ú©Ù…Ù‡ Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†
            if (inputFields.every(i => i.value.length === 1)) {
                verifyBtn.disabled = false;
            } else {
                verifyBtn.disabled = true;
            }
        });

        input.addEventListener('keydown', (e) => {
            // Ø§Ú¯Ø± Backspace ÙØ´Ø±Ø¯Ù‡ Ø´Ø¯ Ùˆ Ú©Ø§Ø¯Ø± Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ØŒ Ø¨Ù‡ Ø¹Ù‚Ø¨ Ø¨Ø±Ùˆ
            if (e.key === 'Backspace' && e.target.value.length === 0 && index > 0) {
                inputFields[index - 1].focus();
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ø¯Ø± Ù‚Ø¨Ù„ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø±ÙØªÙ† Ø¨Ù‡ Ø¢Ù†
                inputFields[index - 1].value = ''; 
            }
        });
    });

    // --------------------------------------------------
    // ØªÙˆØ§Ø¨Ø¹ API
    // --------------------------------------------------

    function getCode() {
        return inputFields.map(input => input.value).join('');
    }

    async function verifyCode() {
        const code = getCode();
        
        if (!userPhone) {
            showStatus("Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯. Ø¨Ù‡ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ø¨Ø§Ø²Ú¯Ø±Ø¯ÛŒØ¯.", 'error');
            return;
        }

        if (code.length !== 6) {
            showStatus("Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ Ø±Ø§ Ø¨Ù‡ Ø·ÙˆØ± Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.", 'error');
            return;
        }

        verifyBtn.disabled = true;
        verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ ØªØ£ÛŒÛŒØ¯...';
        showStatus("Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø¯...", 'success');

        try {
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ API
            const response = await fetch("/verify_sms_code", { 
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phone: userPhone, code: code }) 
            });

            const data = await response.json();
            
            if (response.ok && data.status === "success") {
                // ğŸ’¡ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø§Ø² Local Storage Ù¾Ø³ Ø§Ø² ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚
                localStorage.removeItem('phone_for_verification');
                
                showStatus("âœ… Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...", 'success');
                setTimeout(() => {
                    // Ø¢Ø¯Ø±Ø³ Ø¯Ù‡ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¨Ù‡ Ù…Ø³ÛŒØ± Ø¯Ù„Ø®ÙˆØ§Ù‡ Ù¾Ø³ Ø§Ø² ÙˆØ±ÙˆØ¯
                    window.location.href = data.redirect || '/'; 
                }, 1500);

            } else {
                showStatus("âŒ " + data.message, 'error');
                verifyBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> ØªØ£ÛŒÛŒØ¯ Ùˆ ÙˆØ±ÙˆØ¯';
                verifyBtn.disabled = false;
            }

        } catch (e) {
            console.error("Fetch Error:", e);
            showStatus("âš ï¸ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.", 'error');
            verifyBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> ØªØ£ÛŒÛŒØ¯ Ùˆ ÙˆØ±ÙˆØ¯';
            verifyBtn.disabled = false;
        }
    }
    
    async function resendCode() {
        if (resendLink.classList.contains('disabled') || !userPhone) return;
        
        // ØºÛŒØ± ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú©
        resendLink.classList.add('disabled');
        resendLink.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯...`;
        
        showStatus("Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Ú©Ø¯...", 'success');

        try {
            const response = await fetch("/send_sms_code", { 
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phone: userPhone })
            });

            const data = await response.json();
            
            if (response.ok && data.status === "success") {
                showStatus("âœ… " + data.message, 'success');
            } else {
                showStatus("âŒ " + data.message, 'error');
            }
            
        } catch (e) {
            showStatus("âš ï¸ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.", 'error');
        } finally {
            // ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ù„ÛŒÙ†Ú© Ù¾Ø³ Ø§Ø² ÛŒÚ© Ø¯Ù‚ÛŒÙ‚Ù‡
            let countdown = 60;
            const interval = setInterval(() => {
                countdown--;
                resendLink.innerHTML = `<i class="fas fa-redo"></i> Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ (${countdown} Ø«Ø§Ù†ÛŒÙ‡ Ø¯ÛŒÚ¯Ø±)`;
                if (countdown <= 0) {
                    clearInterval(interval);
                    resendLink.innerHTML = `<i class="fas fa-redo"></i> Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Ú©Ø¯`;
                    resendLink.classList.remove('disabled');
                }
            }, 1000);
        }
    }

    // Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ Ø¯Ú©Ù…Ù‡ ØªØ£ÛŒÛŒØ¯ Ø±Ø§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†
    verifyBtn.disabled = true;
    
    // ØªÙ…Ø±Ú©Ø² Ø®ÙˆØ¯Ú©Ø§Ø± Ø±ÙˆÛŒ Ø§ÙˆÙ„ÛŒÙ† Ú©Ø§Ø¯Ø±
    inputFields[0].focus();

</script>

</body>
</html>